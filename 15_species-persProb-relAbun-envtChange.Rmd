---
output: html_document
editor_options: 
  chunk_output_type: console
---

## Species persistence probabilities and relative abundance as a function of environmental changes

In this script, we will model the effect of species persistence probabilities and relative abundance as a function of environmental changes at each of the sampling sites (environmental changes are calculated as differences in values of a predictor between modern vs. historical time period)

In the first half of the script, we will prepare the environmental predictors at each of the sampling sites

### Load necessary libraries
```{r}
# load libs
library(sf)
library(readr)
library(dplyr)
library(terra)
library(tidyr)
library(mapview)
library(sjPlot)
library(glmmTMB)
library(ggplot2)
library(effects)
library(lme4)
```

## Load land cover data from 1870 and 2017
```{r}
# load 1870 and 2017 shp
lc_1870 <- st_read("data/spatial/1870.shp")
lc_2017 <- st_read("data/spatial/2017.shp")

# Prior to further analysis, the classes have to be renamed so that they match classifications done in 1870 and 2017
# For the sake of further downstream analysis, we ensure that the proportion of land cover estimation is consistent with class names
# We are unable to distinguish between Tea and Timber plantations in the 1870 map and hence, we club Timber and Tea plantations in 2017 as a single class (Plantations)

# cleaning up the 1870 map
lc_1870$class[lc_1870$class=="cultivated tracts"] <- "Agricultural Land"
lc_1870$class[lc_1870$class=="plantations"] <- "Plantations (Tea & Timber)"
lc_1870$class[lc_1870$class=="settlements"] <- "Settlements"
lc_1870$class[lc_1870$class=="waterbodies"] <- "Water Bodies"

# combining classes in the 2017 map
lc_2017$class[lc_2017$class=="Timber Plantations"] <- "Plantations (Tea & Timber)"
lc_2017$class[lc_2017$class=="Tea Plantations"] <- "Plantations (Tea & Timber)"
lc_2017$class[lc_2017$class=="Water bodies"] <- "Water Bodies"
```

## Load modern resruvey locations
```{r}
# load sites
sites <- read_csv("data/list-of-resurvey-locations.csv")
sites <- distinct(sites, modern_site_code, historical_site_code, longitude, latitude)
sites <- sites[-c(1:50),]
```

## Create spatial data within a 250m buffer for each site
```{r}
# make spatial data from sites, with a 250m buffer
sites_sf = st_as_sf(
  sites, coords = c("longitude", "latitude"),
  crs = 4326
) |> 
  st_transform(32643) |> 
  st_buffer(250)
```

```{r}
# get intersection with 1870 and 2017 data
lc_sites <- lapply(
  list(lc_1870, lc_2017), function(x) {
    st_intersection(x, sites_sf)
  }
)

# calculate area for each lc type for sites based on modern site code
lc_sites <- lapply(lc_sites, function(df) {
  df |> 
    mutate(
      area = as.numeric(st_area(df))
    ) |> 
    st_drop_geometry() |> 
    group_by(modern_site_code, class) |> 
    summarise(prop_lc = area / sum(area))
})

# add year and merge
lc_sites <- Map(
  lc_sites, c(1870, 2017),
  f = function(df, y) {
    df$year = y
    df
  }
) |> 
  bind_rows()
```

```{r}
# get lc change sites
lc_change_dat <- lc_sites |> 
  pivot_wider(
    id_cols = c("modern_site_code", "class"),
    names_from = c("year"),
    values_from = "prop_lc",
    values_fn = mean
  ) |> 
  rename(
    year_1870 = `1870`,
    year_2017 = `2017`
  ) %>%
  left_join(., sites, by="modern_site_code") %>%
  replace(is.na(.), 0) %>%
  mutate("lc_change" = year_2017 - year_1870) #  -1 implies loss and + 1 implies gain
```

```{r}
# save as is for further processing
write_csv(
  lc_change_dat, file = "results/lc_change.csv"
)
```

## Climate change at sampling sites
```{r}
# load climate data
raster_temp = list.files("data/climate/", pattern = "t_mean", full.names = T) |> 
  lapply(rast)

raster_rain = list.files("data/climate/", pattern = "ppt", full.names = T) |> 
  lapply(rast)
```

```{r}
# get difference between first and last files
climate_change = lapply(
  list(raster_temp, raster_rain),
  function(le) {
    lapply(le, function(le2) {
      le2[[length(names(le2))]] - le2[[1]]
    })
  }
) |> 
  Reduce(f = c) # convert to single list

# get raster names
climate_change_names = lapply(climate_change, function(ra) {
  lapply(ra, function(r) {
    r |> names() |> stringr::str_extract("(.*?)(?=_\\d+)")
  })
}) |> unlist()
```

```{r}
# get mean change within 250m buffer of resurvey locs
climate_change_sites = lapply(
  climate_change, function(ra) {
    terra::extract(
      ra, 
      y = terra::vect(
        sites_sf |> 
          st_transform(4326)
      ), fun = mean
    )  
  }
)

# combine all metrics
climate_change_sites = Reduce(f = left_join, x = climate_change_sites)

# attach to sampling sites
sites <- mutate(sites, ID = seq(nrow(sites)))
clim_change_dat <- left_join(sites, climate_change_sites)
```

```{r}
# save site data
write_csv(
  clim_change_dat, file = "results/climate_change.csv"
)
```

### Load species persistence probabilities at site and landscape level
```{r}
spec_site_persProb <- read.csv( "results/species-persProb-siteLevel.csv")
spec_persProb <- read.csv("results/species-persProb-landscapeLevel.csv")
```

## Load species relative abundance
```{r}
relAbun <- read.csv("results/species-relative-abundance-siteLevel.csv")
```

## Run mixed-effects models examining persistence probabilties and land cover change
```{r}
## change in persistence prob over time (site level)
persProb_min <- spec_site_persProb %>%
  dplyr::select(years,PXt,scientific_name, historical_site_code) %>%
  group_by(scientific_name, historical_site_code) %>%
  slice(which.min(years)) %>%
  rename(., PXt_min = "PXt") %>%
  ungroup()

persProb_max <- spec_site_persProb %>%
  dplyr::select(years,PXt,scientific_name, historical_site_code) %>%
  group_by(scientific_name, historical_site_code) %>%
  slice(which.max(years)) %>%
  rename(., PXt_max = "PXt") %>%
  ungroup()

## join the two dataframes
persProb_change <- full_join(persProb_min[,-1], persProb_max[,-1]) %>%
  mutate("persProbChange" = PXt_min - PXt_max) %>%
  ungroup()

### make land cover data wider
lc_change_glmm <- lc_change_dat %>%
  pivot_wider(names_from = class, values_from = lc_change) %>%
  ungroup() %>%
  dplyr::select(`historical_site_code`, `Shola Grassland`, `Settlements`, `Shola Forest`,`Plantations (Tea & Timber)`, `Agricultural Land`) %>%
  distinct(.) %>%
  replace(is.na(.), 0) %>% 
  group_by(historical_site_code) %>%
  summarise(across(everything(), sum)) %>%
  mutate("Shola Grassland" = case_when(`Shola Grassland` < -1 ~ -1,
                                       `Shola Grassland` > 1 ~ 1,
                                       TRUE ~ as.numeric(`Shola Grassland`))) %>%
  mutate("Settlements" = case_when(`Settlements` < -1 ~ -1,
                                       `Settlements` > 1 ~ 1,
                                       TRUE ~ as.numeric(`Settlements`))) %>%
  mutate("Shola Forest" = case_when(`Shola Forest` < -1 ~ -1,
                                       `Shola Forest` > 1 ~ 1,
                                       TRUE ~ as.numeric(`Shola Forest`))) %>%
  mutate("Plantations (Tea & Timber)" = case_when(`Plantations (Tea & Timber)`< -1 ~ -1, `Plantations (Tea & Timber)` > 1 ~ 1, TRUE ~ as.numeric(`Plantations (Tea & Timber)`))) %>%
  mutate("Agricultural Land" = case_when(`Agricultural Land` < -1 ~ -1,
                                       `Agricultural Land` > 1 ~ 1,
                                       TRUE ~ as.numeric(`Agricultural Land`))) %>%
  ungroup()

# in the above dataframe, we lost KJPN and KULR as it's a low elevation site and our land cover data does not sample that area
# hence we filter those sites from the persProbChange for the landscape change analysis

persProb_landCover <- persProb_change %>%
  filter(historical_site_code != "KJPN") %>%
  filter(historical_site_code != "KULR")
  
glmm_persProb <- left_join(persProb_landCover, lc_change_glmm, by="historical_site_code") %>% as.data.frame()

## run the glmm
glmm_lc_persProb <- glmer(persProbChange ~ `Shola Grassland` + `Shola Forest` + `Settlements`+ `Plantations (Tea & Timber)` + `Agricultural Land` +
                          (1|scientific_name) + (1|historical_site_code), 
                        data = glmm_persProb, family = gaussian(link="identity"))

summary(glmm_lc_persProb)
plot_model(glmm_lc_persProb, type="pred")
report::report(glmm_lc_persProb)

# We fitted a linear mixed model (estimated using REML and nloptwrap optimizer) to predict persProbChange with Shola Grassland, Shola Forest, Settlements, Plantations (Tea & Timber) and Agricultural Land (formula: persProbChange ~ `Shola Grassland` + `Shola Forest` + Settlements + `Plantations (Tea & Timber)` + `Agricultural Land`). The model included scientific_name and historical_site_code as random effects (formula: list(~1 | scientific_name, ~1 | historical_site_code)). The model's total explanatory power is substantial (conditional R2 = 0.64) and the part related to the fixed effects alone (marginal R2) is of 0.03. The model's intercept, corresponding to Shola Grassland = 0, Shola Forest = 0, Settlements = 0, Plantations (Tea & Timber) = 0 and Agricultural Land = 0, is at 0.14 (95% CI [-0.06, 0.35], t(1139) = 1.36, p = 0.175). Within this model:

#  - The effect of Shola Grassland is statistically non-significant and negative (beta = -0.05, 95% CI [-0.25, 0.15], t(1139) = -0.49, p = 0.623; Std. beta = -0.02, 95% CI [-0.09, 0.05])
#  - The effect of Shola Forest is statistically non-significant and negative (beta = -3.59e-03, 95% CI [-0.03, 0.03], t(1139) = -0.23, p = 0.817; Std. beta = -0.01, 95% CI [-0.13, 0.10])
#  - The effect of Settlements is statistically significant and positive (beta = 0.05, 95% CI [0.01, 0.08], t(1139) = 2.81, p = 0.005; Std. beta = 0.16, 95% CI [0.05, 0.27])
#  - The effect of Plantations (Tea & Timber) is statistically non-significant and positive (beta = 0.02, 95% CI [-0.03, 0.07], t(1139) = 0.76, p = 0.448; Std. beta = 0.04, 95% CI [-0.06, 0.14])
#  - The effect of Agricultural Land is statistically non-significant and positive (beta = 0.01, 95% CI [-0.03, 0.06], t(1139) = 0.57, p = 0.567; Std. beta = 0.03, 95% CI [-0.07, 0.13])

# Standardized parameters were obtained by fitting the model on a standardized version of the dataset. 95% Confidence Intervals (CIs) and p-values were computed using the Wald approximation
```

## Run mixed-effects models examining species relative abundance and land cover change
```{r}
names(relAbun) <- c("scientific_name","historical_site_code","year","relAbundance")

pivot_1850 <- relAbun %>%
  filter(year != 1900) %>%
  filter(year != 2021) %>%
  pivot_wider(., names_from = "year", values_from = "relAbundance")

pivot_2021 <- relAbun %>%
  filter(year != 1900) %>%
  filter(year != 1850) %>%
  pivot_wider(., names_from = "year", values_from = "relAbundance")

relAbun_wide <- full_join(pivot_1850, pivot_2021, by=c("scientific_name","historical_site_code")) %>%
  replace(is.na(.), 0) %>%
  mutate("relAbunChange" = `1850` - `2021`)

glmm_relAbun <- left_join(lc_change_glmm, relAbun_wide, by="historical_site_code") %>% as.data.frame()

## run the glmm
glmm_lc_relAbun <- glmer(relAbunChange ~ `Shola Grassland` + `Shola Forest` + `Settlements`+ `Plantations (Tea & Timber)` + `Agricultural Land` +
                          (1|scientific_name) + (1|historical_site_code), 
                        data = glmm_relAbun, family = gaussian(link="identity"))

summary(glmm_lc_relAbun)
plot_model(glmm_lc_relAbun, type="pred")
report::report(glmm_lc_relAbun)

# We fitted a linear mixed model (estimated using REML and nloptwrap optimizer) to predict relAbunChange with Shola Grassland, Shola Forest, Settlements, Plantations (Tea & Timber) and Agricultural Land (formula: relAbunChange ~ `Shola Grassland` + `Shola Forest` + Settlements + `Plantations (Tea & Timber)` + `Agricultural Land`). The model included scientific_name and historical_site_code as random effects (formula: list(~1 | scientific_name, ~1 | historical_site_code)). The model's total explanatory power is moderate (conditional R2 = 0.13) and the part related to the fixed effects alone (marginal R2) is of 2.07e-03. The model's intercept, corresponding to Shola Grassland = 0, Shola Forest = 0, Settlements = 0, Plantations (Tea & Timber) = 0 and Agricultural Land = 0, is at -8.92e-03 (95% CI [-0.02, 1.72e-03], t(4905) = -1.64, p = 0.100). Within this model:

#  - The effect of Shola Grassland is statistically non-significant and negative (beta = -3.37e-03, 95% CI [-0.01, 6.85e-03], t(4905) = -0.65, p = 0.518; Std. beta = -0.01, 95% CI [-0.04, 0.02])
 # - The effect of Shola Forest is statistically non-significant and negative (beta = -7.56e-04, 95% CI [-2.44e-03, 9.28e-04], t(4905) = -0.88, p = 0.379; Std. beta = -0.02, 95% CI [-0.05, 0.02])
#  - The effect of Settlements is statistically non-significant and positive (beta = 9.92e-04, 95% CI [-7.97e-04, 2.78e-03], t(4905) = 1.09, p = 0.277; Std. beta = 0.02, 95% CI [-0.01, 0.05])
#  - The effect of Plantations (Tea & Timber) is statistically non-significant and positive (beta = 2.32e-03, 95% CI [-4.72e-04, 5.11e-03], t(4905) = 1.63, p = 0.103; Std. beta = 0.03, 95% CI [-5.35e-03, 0.06])
#  - The effect of Agricultural Land is statistically non-significant and positive (beta = 1.20e-03, 95% CI [-1.35e-03, 3.74e-03], t(4905) = 0.92, p = 0.357; Std. beta = 0.01, 95% CI [-0.02, 0.05])

# Standardized parameters were obtained by fitting the model on a standardized version of the dataset. 95% Confidence Intervals (CIs) and p-values were computed using the Wald approximation
```


## Run mixed-effects models examining persistence probabilties and climate change
```{r}
## we have four predictors for climate
## prep data at the level of the historical site
clim_change_glmm <- clim_change_dat %>%
  dplyr::select(historical_site_code, t_mean_dry_2010, t_mean_rainy_2010, ppt_dry_2010, ppt_rainy_2010) %>%
  group_by(historical_site_code) %>%
  summarise(across(everything(), mean))

## dataframe for glmm
glmm_cc_change <- left_join(persProb_change, clim_change_glmm, by="historical_site_code") %>%
  as.data.frame()

## run the glmm
glmm_cc <- glmer(persProbChange ~ t_mean_dry_2010 + t_mean_rainy_2010 +
                   ppt_dry_2010 + ppt_rainy_2010 +
                          (1|scientific_name) + (1|historical_site_code), 
                        data = glmm_cc_change, family = gaussian(link="identity"))

summary(glmm_cc)
plot_model(glmm_cc, type="pred")
plot_model(glmm_cc, type = "est")
report::report(glmm_cc)
```

