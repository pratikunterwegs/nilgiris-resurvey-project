---
editor_options: 
  chunk_output_type: console
---

## Historical-modern occurrence comparisons by elevation

Here, we will compare historical and modern occurrence data and test for differences in presences/absences of species across time periods and sites by elevation. 

Scenario 1  

We plot the presence/absence of each species by elevation assuming that the data from multiple modern survey sites correspond to a single historical survey site. Due to lack of clarity on the exact location where species were historically collected from, multiple modern survey locations were chosen to correspond to a single historic survey site. In some cases, these modern survey sites span a range of elevations and hence the assumption here is that the elevational range for a species historically could span the range of elevations corresponding to the modern survey locations.  

For this script and further analyses, we choose a minimum number of four observations per species time-period for comparisons. This is being done to reduce the number of singletons in the analyses. A second crteria being applied is the removal of data from the time-period 1900-1950 and keeping the comparisons restricted to 1850-1900 vs. 2021.  

### Load necessary libraries
```{r}
library(dplyr)
library(stringr)
library(tidyverse)
library(scico)
library(RColorBrewer)
library(extrafont)
library(sf)
library(raster)

# function to scale a range of values between 0 and 1
range01 <- function(x, ...){(x - min(x, ...)) / (max(x, ...) - min(x, ...))}

## for plotting
library(viridis)
library(colorspace)
library(tmap)
library(scales)
library(ggplot2)
library(patchwork)
library(mapview)
```

### Load list of resurvey locations

We will load the list of sites across which a modern resurvey was carried out, along with elevation rasters. 
```{r}
# load list of resurvey locations and add elevation as a variable
# remove the modern resurvey locations only (ie. ASFQ)
sites <- read.csv("data/list-of-resurvey-locations.csv")
sites <- sites[-c(1:50),]

# convert to sf object and transform
sites <- st_as_sf(sites, coords = c("longitude", "latitude")) %>%
  `st_crs<-`(4326) %>%
  st_transform(32643)

# add elevation raster
alt <- raster("data/spatial/elevation/alt") # this layer is not added to github as a result of its large size and can be downloaded from SRTM (Farr et al. (2007))

# extract values from that raster (note: transformation of coordinate system)
elev <- raster::extract(alt, sites)
sites <- cbind(sites, elev)
```

### Load historical and modern occurrence data

For the historical occurrence data, we will choose data from a single time period: 1850-1900. 
```{r}
## read in historical occurrence data
hist_occ <- read.csv("data/historical-occurrence-data.csv")

## filter observations by date
hist_occ <- hist_occ %>%
  filter(year <= 1900)

## remove species with few observations
histCount <- hist_occ %>%
  group_by(scientific_name) %>%
  count() 

## A total of 147 species were reported in the historical data

## Only 68 species had a minimum number of four records (random criteria being used for analyses)

## filter species list with a minimum of four records
histCount_minFour <- histCount %>%
  filter(n >= 4 )

## filter species to include only 68 species
hist_occ <- hist_occ %>%
  filter(scientific_name %in% histCount_minFour$scientific_name)

## group by scientific name and historical site code
## add an abundance column and a presence/absence column
hist_pres_abs <- hist_occ %>%
  group_by(scientific_name, historical_site_code) %>%
  count() %>%
  rename(., "abundance1850" = n) %>%
  mutate("Y1850" = case_when(abundance1850 >= 1 ~ 1,TRUE ~ 0)) %>%
  left_join(., sites, by=c("historical_site_code"="historical_site_code")) %>%
  filter(!is.na(scientific_name)) %>%
  replace(is.na(.), 0)

## read in modern occurrence data
mod_occ <- read.csv("data/modern-occurrence-data.csv")

## count of modern data
modCount <- mod_occ %>%
  group_by(scientific_name) %>%
  count() 

## group by scientific name and modern site code
mod_occ <- mod_occ %>%
  filter(!is.na(historical_site_code)) %>%
  filter(!is.na(species_code)) %>%
  group_by(scientific_name, modern_site_code) %>%
  summarise(abundance2021 = sum(number))

## join the dataset with the sites object to include historical site code
mod_occ <-  left_join(mod_occ, sites, by=c("modern_site_code"="modern_site_code")) %>% filter(!is.na(scientific_name)) %>%
  replace(is.na(.), 0)  %>%
  mutate("Y2021" = case_when(abundance2021 >= 1 ~ 1,TRUE ~ 0))

## recount the abundance data by grouping by the historical_site_code
mod_occ <- mod_occ %>%
  group_by(scientific_name, historical_site_code, elev) %>%
  summarise(abundance2021 = sum(abundance2021))

## only include species that are present in the historical dataset
mod_pres_abs <- mod_occ %>%
  filter(scientific_name %in% hist_pres_abs$scientific_name)

## We notice above that six species are recorded in the historical dataset, but are not present in the modern survey.

## These species include: 
## "Amandava amandava"    
## "Clamator jacobinus"   
## "Cyornis pallidipes"  
## "Galloperdix lunulata" 
## "Harpactes fasciatus"  
## "Perdicula asiatica" 
```

### Join the historical and modern count data
```{r}
## joining the historic and modern datasets
hist_mod <- full_join(hist_pres_abs, mod_pres_abs, by =               c("scientific_name","modern_site_code","historical_site_code","modern_landCover_type","elev","site_name","geometry")) %>%
  replace_na(list(abundance1850 = 0, 
                  abundance2021 = 0,
                  Y1850 = 0,
                  Y2021= 0 )) %>%
  arrange(scientific_name) %>%
  ungroup()
```

### Comparing historical-modern counts by elevation

We will create plots using presence-nondetection first
```{r}
# run the loop to create a list of plots
plots <- list()

for(i in 1:length(unique(hist_mod$scientific_name))) {
  
  # extract data species by species
  a <- unique(hist_mod$scientific_name)[i]
  data <- hist_mod[hist_mod$scientific_name==a,] %>%
      pivot_longer(cols=c("Y1850", "Y2021"), 
                   names_to="histMod", values_to="PresAbs") %>%
    mutate("det_nonDet" = case_when(PresAbs == 1 ~ "Detection",
                                    PresAbs == 0 ~ "Non-detection")) %>%
    arrange(histMod)
  
  # plot the data
  plots[[i]] <- ggplot(data, aes(x = histMod, y = elev, fill = factor(det_nonDet))) +
    geom_point(aes(shape=factor(det_nonDet), size = 3)) +
    scale_shape_manual(values = c("Detection" = 16, "Non-detection" = 1), na.translate = F) +
  theme_bw() +
  ggtitle(a) +
  labs(
    x = "\nHistoric vs. Modern Survey",
    y = "Elevation (in meters)\n"
  ) +
  theme(
    plot.title = element_text(family = "Century Gothic", face="bold.italic"),
    axis.title = element_text(
      family = "Century Gothic",
      size = 14, face = "bold"
    ),
    axis.text = element_text(family = "Century Gothic", size = 13),
    axis.text.x = element_text(angle = 0, vjust = 0.5, hjust = 0.5), 
    legend.title = element_text(family = "Century Gothic"),
    legend.text = element_text(family = "Century Gothic")) + 
    guides(size= "none",
           fill = "none",
           shape = guide_legend(title = ""))
}

# plot and save as a single pdf
cairo_pdf(
  filename = "figs/elevation-historic-modern-occurrence.pdf",
  onefile = TRUE
)
plots
dev.off()
```
