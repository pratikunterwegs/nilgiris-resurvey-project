---
editor_options: 
  chunk_output_type: console
---

## Historical-modern occurrence comparisons by elevation

Here, we will compare historical and modern occurrence data and test for differences in presences/absences of species across time periods and sites by elevation. 

Scenario 1  

We plot the presence/absence of each species by elevation assuming that the data from multiple modern survey sites correspond to a single historical survey site. Due to lack of clarity on the exact location where species were historically collected from, multiple modern survey locations were chosen to correspond to a single historic survey site. In some cases, these modern survey sites span a range of elevations and hence the assumption here is that the elevational range for a species historically could span the range of elevations corresponding to the modern survey locations.  

### Load necessary libraries

```{r}
library(dplyr)
library(stringr)
library(tidyverse)
library(scico)
library(RColorBrewer)
library(extrafont)
library(sf)
library(raster)

# function to scale a range of values between 0 and 1
range01 <- function(x, ...){(x - min(x, ...)) / (max(x, ...) - min(x, ...))}
```

### Load list of resurvey locations

We will load the list of sites across which a modern resurvey was carried out, along with elevation rasters. 
```{r}
# load list of resurvey locations and add elevation as a variable
# remove the modern resurvey locations only (ie. ASFQ)
sites <- read.csv("data/list-of-resurvey-locations.csv")
sites <- sites[-c(1:50),]

# convert to sf object and transform
sites <- st_as_sf(sites, coords = c("longitude", "latitude")) %>%
  `st_crs<-`(4326) %>%
  st_transform(32643)

# add elevation raster
alt <- raster("data/spatial/elevation/alt") # this layer is not added to github as a result of its large size and can be downloaded from SRTM (Farr et al. (2007))

# extract values from that raster (note: transformation of coordinate system)
elev <- raster::extract(alt, sites)
sites <- cbind(sites, elev)
```

### Load historical and modern occurrence data

For the historical occurrence data, we will choose data from three time periods: 1850-1900, 1900-1950 and 1950-2000. 
```{r}
## read in historical occurrence data
hist_occ <- read.csv("data/historical-occurrence-data.csv")

### pre-1900
hist_occ_pre1900 <- hist_occ %>%
  filter(year <= 1900)

## group by scientific name and historical site code and join the sites dataframe
hist_occ_pre1900 <- hist_occ_pre1900 %>%
  group_by(scientific_name, historical_site_code) %>%
  count() %>%
  rename(., "abundance1850" = n) %>%
  mutate("Y1850" = case_when(abundance1850 >= 1 ~ 1,TRUE ~ 0)) %>%
  left_join(., sites, by=c("historical_site_code"="historical_site_code")) %>%
  filter(!is.na(scientific_name)) %>%
  replace(is.na(.), 0)
  
# repeat above for two more time-periods
## 1900-1950
hist_occ_1900_1950 <- hist_occ %>%
  filter(year > 1900 & year <= 1950)

## group by scientific name and historical site code and join the sites dataframe
hist_occ_1900_1950 <- hist_occ_1900_1950 %>%
  group_by(scientific_name, historical_site_code) %>%
  count() %>%
  rename(., "abundance1900" = n) %>%
  mutate("Y1900" = case_when(abundance1900 >= 1 ~ 1,TRUE ~ 0)) %>%
  left_join(., sites, by=c("historical_site_code"="historical_site_code")) %>%
  filter(!is.na(scientific_name)) %>%
  replace(is.na(.), 0)

## read in modern occurrence data
mod_occ <- read.csv("data/modern-occurrence-data.csv")

## group by scientific name and modern site code
mod_occ <- mod_occ %>%
  filter(!is.na(historical_site_code)) %>%
  filter(!is.na(species_code)) %>%
  group_by(scientific_name, modern_site_code) %>%
  summarise(modCount = sum(number))

mod_occ <-  left_join(mod_occ, sites, by=c("modern_site_code"="modern_site_code")) %>% filter(!is.na(scientific_name)) %>%
  replace(is.na(.), 0) %>%
  mutate("Y2021" = case_when(modCount >= 1 ~ 1,TRUE ~ 0))
```

## Join the historical and modern count data
```{r}
## joining the historic and modern datasets
## this dataframe can be used to examine land cover data later on
hist_mod <- full_join(hist_occ_pre1900, hist_occ_1900_1950, by = c("scientific_name","modern_site_code","historical_site_code","modern_landCover_type","elev","site_name","geometry")) %>%
   full_join(., mod_occ, by = c("scientific_name","modern_site_code","historical_site_code","modern_landCover_type","elev","site_name","geometry")) %>%
  mutate_at(vars(Y2021), ~replace_na(., 0)) %>%
  arrange(scientific_name) %>%
  ungroup()
```

### Comparing historical-modern counts by elevation
```{r}
# run the loop to create a list of plots
plots <- list()

for(i in 1:length(unique(hist_mod$scientific_name))) {
  
  # extract data species by species
  a <- unique(hist_mod$scientific_name)[i]
  data <- hist_mod[hist_mod$scientific_name==a,] %>%
      pivot_longer(cols=c("Y1850", "Y1900", "Y2021"), 
                   names_to="histMod", values_to="PresAbs") %>%
    mutate("det_nonDet" = case_when(PresAbs == 1 ~ "Detection",
                                    PresAbs == 0 ~ "Non-detection")) %>%
    arrange(histMod)
  
  # plot the data
  plots[[i]] <- ggplot(data, aes(x = histMod, y = elev, fill = factor(det_nonDet))) +
    geom_point(aes(shape=factor(det_nonDet), size = 3)) +
    scale_shape_manual(values = c("Detection" = 16, "Non-detection" = 1), na.translate = F) +
  theme_bw() +
  ggtitle(a) +
  labs(
    x = "\nHistoric vs. Modern Survey",
    y = "Elevation (in meters)\n"
  ) +
  theme(
    plot.title = element_text(family = "Century Gothic", face="bold.italic"),
    axis.title = element_text(
      family = "Century Gothic",
      size = 14, face = "bold"
    ),
    axis.text = element_text(family = "Century Gothic", size = 13),
    axis.text.x = element_text(angle = 0, vjust = 0.5, hjust = 0.5), 
    legend.title = element_text(family = "Century Gothic"),
    legend.text = element_text(family = "Century Gothic")) + 
    guides(size= "none",
           fill = "none",
           shape = guide_legend(title = ""))
}

# plot and save as a single pdf
cairo_pdf(
  filename = "figs/elevation-historic-modern-occurrence.pdf",
  onefile = TRUE
)
plots
dev.off()
```
