---
editor_options: 
  chunk_output_type: console
---

# Land cover data analysis

In this script, we will analyze land cover changes for multiple land cover classes between 1870 and 2017.  

### Load necessary libraries
```{r}
library(sf)
library(raster)
library(terra)
library(stars)
library(dplyr)
library(tidyverse)
library(mapview)
library(landscapemetrics)
library(scico)
```

### Load the Nilgiris contour 

This is the contour to which all other shapefiles will be clipped to and is essentially a 1400 m contour. 
```{r}
# load the 1400m contour
contourNil <- st_read("data/spatial/contour-1400m-nilgiris.shp")
```

### Loading digitized shapefiles of the 1870 Ouchterlony map

The 1870 published maps were based on a survey carried out in 1848 by J. Ouchterlony. 
```{r}
# list all shapefiles in the directory
nilgiris1870 <- list.files("data/spatial/1870-nilgiris/", full.names = T,
                    recursive = T, pattern=".shp$")

# create vector files
cultivated_nil1870 <- st_read(nilgiris1870[1])
forest_nil1870 <- st_read(nilgiris1870[2])
grassland_nil1870 <- st_read(nilgiris1870[3])
plantations_nil1870 <- st_read(nilgiris1870[4])
roads_nil1870 <- st_read(nilgiris1870[5])
settlements_nil1870 <- st_read(nilgiris1870[6])
waterBodies_nil1870 <- st_read(nilgiris1870[7])

# explore and fix any issues with the above vector files

# fix class names and remove empty geometries
plantations_nil1870$class <- "plantations"
settlements_nil1870 <- settlements_nil1870[-371, ]

# Note: the roads shapefile is a linestring while the other geometry types are polygon

# transform to UTM 43N
cultivated_nil1870 <- st_transform(cultivated_nil1870, 32643)
forest_nil1870 <- st_transform(forest_nil1870, 32643)
grassland_nil1870 <- st_transform(grassland_nil1870, 32643)
plantations_nil1870 <- st_transform(plantations_nil1870, 32643)
settlements_nil1870 <- st_transform(settlements_nil1870, 32643)
waterBodies_nil1870 <- st_transform(waterBodies_nil1870, 32643)

# some more processing to ensure class names are standardized across time periods
forest_nil1870$class <- "Shola Forest"
grassland_nil1870 <- st_cast(grassland_nil1870, "POLYGON")
grassland_nil1870$class <- "Shola Grassland"
waterBodies_nil1870$class <- "waterbodies"

# creating a single simple feature collection
nil1870 <- rbind(
  cultivated_nil1870, forest_nil1870, grassland_nil1870,
  plantations_nil1870, settlements_nil1870, waterBodies_nil1870
)

# crop the 1870 shapefiles to within the 1400m contour only
nil1870 <- st_buffer(nil1870, dist = 0)
nil1870 <- st_intersection(nil1870, contourNil)
nil1870 <- nil1870[, -c(4, 5, 6)]

# the above steps have resulted in a single dataframe for the 1400m contour only
```

### Loading the Kundah 1870 digitized shapefiles

These shapefiles have been digitized from a map of the Koondah mountains (based on a survey by J. Ouchterlony).  
```{r}
# load the Kundah 1870 shapefiles
kundah <- list.files("data/spatial/1870-kundah/",
  full.names = T,
  recursive = T, pattern = ".shp$"
)

# create vector files
forest_kun1870 <- st_read(kundah[1])
grassland_kun1870 <- st_read(kundah[2])
settlements_kun1870 <- st_read(kundah[3])
waterbodies_kun1870 <- st_read(kundah[4])
# whitebars_kun1870 <- st_read(kundah[5])

# explore and fix any issues with the above vector files

names(forest_kun1870) <- c("id", "class", "gridcode", "geometry")
settlements_kun1870$class <- "settlements"

# transform to UTM 43N
forest_kun1870 <- st_transform(forest_kun1870, 32643)
grassland_kun1870 <- st_transform(grassland_kun1870, 32643)
settlements_kun1870 <- st_transform(settlements_kun1870, 32643)
waterbodies_kun1870 <- st_transform(waterbodies_kun1870, 32643)

# some more processing to ensure class names are standardized across time periods
forest_kun1870$class <- "Shola Forest"
grassland_kun1870 <- st_cast(grassland_kun1870, "POLYGON")
grassland_kun1870$class <- "Shola Grassland"

# creating a single simple feature collection
kun1870 <- rbind(forest_kun1870, grassland_kun1870, settlements_kun1870, waterbodies_kun1870)

# crop the 1870 shapefiles to within the 1400m contour only
kun1870 <- st_buffer(kun1870, dist = 0)
kun1870 <- st_intersection(kun1870, contourNil)
kun1870 <- kun1870[, -c(4, 5, 6)]

# cast once to make sure all are polygons
kun1870 <- st_cast(kun1870, "POLYGON")

# Combine the nilgiris 1870 (Ouchterlony map) and the kundah 1870 for clipping
# with files from other time periods (see below)
all1870 <- rbind(nil1870, kun1870)
all1870 <- st_buffer(st_union(all1870), dist = 0)
```

### Load digitized shapefiles of a 1910 map

The 1910 map is a stitched raster based on tiles created by Survey of India.  

```{r}
# load the nilgiris 1910 shapefiles
nil1910 <- list.files("data/spatial/1910-nilgiris/", full.names = T,
                    recursive = T, pattern=".shp$")

# create vector files
cultivated_nil1910 <- st_read(nil1910[1])
forest_nil1910 <- st_read(nil1910[2])
grassland_nil1910 <- st_read(nil1910[3])
plantations_nil1910 <- st_read(nil1910[4]) # note: 1 geometry is empty
settlements_nil1910 <- st_read(nil1910[5])
unclassified_nil1910 <- st_read(nil1910[6])
waterBodies_nil1910 <- st_read(nil1910[7])

# fixing issues with the vector files above
# remove empty geometries and correct column name errors
plantations_nil1910 <- plantations_nil1910[-35,]
names(forest_nil1910)[2] <- "class"
names(unclassified_nil1910)[2] <- "class"
names(waterBodies_nil1910)[2] <- "class"

# fix class names
settlements_nil1910$class <- "settlements"
forest_nil1910$class <- "Shola Forest"
grassland_nil1910$class <- "Shola Grassland"

# transform to UTM 43N
cultivated_nil1910 <- st_transform(cultivated_nil1910, 32643)
forest_nil1910 <- st_transform(forest_nil1910, 32643)
grassland_nil1910 <- st_transform(grassland_nil1910, 32643)
plantations_nil1910 <- st_transform(plantations_nil1910, 32643)
settlements_nil1910 <- st_transform(settlements_nil1910, 32643)
unclassified_nil1910 <- st_transform(unclassified_nil1910, 32643)
waterBodies_nil1910 <- st_transform(waterBodies_nil1910, 32643)

# creating a single simple feature collection
nil1910 <- rbind(cultivated_nil1910, forest_nil1910, grassland_nil1910,
           plantations_nil1910, settlements_nil1910, unclassified_nil1910, 
           waterBodies_nil1870)


# to do:
# st_cast the multipolygons to polygons?
# overlap in multiple land cover....?
# maybe don't rbind them? hmmm but it needs to be the same contour that's all
# overlap doesnt matter because we are calculating area of class by class? 

# crop the 1910 shapefiles to within the 1400m contour only
nil1910 <- st_buffer(nil1910,dist=0)
nil1910 <- st_intersection(nil1910, all1870)
kun1870 <- kun1870[,-c(4,5,6)]

  

```



Load the shapefiles from 1973, 1995 and 2017 for the Nilgiris
```{r}
# load the 1973, 1995 and 2017 shapefiles
nil1973 <- st_read("data/spatial/1973-nilgiris/1973D.shp")
nil1995 <- st_read("data/spatial/1995-nilgiris/1995D.shp")
nil2017 <- st_read("data/spatial/2017-nilgiris/2017D.shp")

# Each of the above shapefiles have slightly different characteristics
# class name is present only in nil2017 and not in the others
# nil 1973 and nil 1995 are of geometry type MULITPOLYGON while nil 2017 is of geometry type POLYGON

# Let's first add class name to nil1973 shapefile
nil1973 <- nil1973 %>%
  mutate(class = case_when(
    gridcode == 1 ~ "Shola Grassland",
    gridcode == 2 ~ "Shola Forest",
    gridcode == 3 ~ "Timber Plantations",
    gridcode == 4 ~ "Tea Plantations",
    gridcode == 5 ~ "Ochlandra",
    gridcode == 6 ~ "Settlements",
    gridcode == 7 ~ "Agricultural Land",
    gridcode == 8 ~ "Water bodies"
  ))

# Let's add class name to nil1995 shapefile
nil1995 <- nil1995 %>%
  mutate(class = case_when(
    gridcode == 1 ~ "Shola Grassland",
    gridcode == 2 ~ "Shola Forest",
    gridcode == 3 ~ "Timber Plantations",
    gridcode == 4 ~ "Tea Plantations",
    gridcode == 5 ~ "Ochlandra",
    gridcode == 6 ~ "Settlements",
    gridcode == 7 ~ "Agricultural Land",
    gridcode == 8 ~ "Water bodies"
  ))

# cast from MULTIPOLYGON to POLYGON to match nil2017 shapefile
nil1973 <- st_cast(nil1973, "POLYGON")
nil1995 <- st_cast(nil1995, "POLYGON")

# crop the 1973, 1995 and 2017 shapefiles to within the 1400m contour only

nil1973 <- st_intersection(nil1973, all1870)
nil1995 <- st_intersection(nil1995, all1870)
nil2017 <- st_intersection(nil2017, all1870)

# if needed the geometry collection can be specifically cast as POLYGON
# nil1973 <- st_cast(nil1973,"POLYGON")
# nil1995 <- st_cast(nil1995,"POLYGON")
# nil2017 <- st_cast(nil2017,"POLYGON")
```

### Calculating area of land cover types 

The decision to use a vector or raster for further analysis depends on the question being asked. Please refer to script in code/01_vectorVsRaster.R

Let's first carry out area-based analysis (we will use rasters for now)
```{r}
# Please note that for the sake of area-calculation we separate the nil1870 and kun 1870 files as they are of different resolutions and need to be resampled and rasterized

# nil1870 raster
vectnil1870 <- terra::vect(nil1870)
emptyRast <- terra::rast(res = 12, xmin = 661012.738348484, xmax = 718286.685853398, ymin = 1240744.4111945, ymax = 1275965.51753469, crs = "+proj=utm +zone=43 +datum=WGS84 +units=m +no_defs")
rastnil1870 <- terra::rasterize(vectnil1870, emptyRast, "class")

# kun1870 raster
vectkun1870 <- terra::vect(kun1870)
emptyRast <- terra::rast(res = 6, xmin = 655224.34214709, xmax = 684285.317723394, ymin = 1230555.09211126, ymax = 1259825.72789338, crs = "+proj=utm +zone=43 +datum=WGS84 +units=m +no_defs")
rastkun1870 <- terra::rasterize(vectkun1870, emptyRast, "class")

# Let's load the 1973, 1995 and 2017 series and rasterize them
vectnil1973 <- vect(nil1973)
emptyRast1973 <- terra::rast(res = 30, xmin = 655224.34214709, xmax = 718286.685853398, ymin = 1230555.09211126, ymax = 1275965.51753469, crs = "+proj=utm +zone=43 +datum=WGS84 +units=m +no_defs")
rastnil1973 <- terra::rasterize(vectnil1973, emptyRast1973, "class")
sz1973 <- cellSize(rastnil1973, unit = "m")
areaRast1973 <- zonal(sz1973, rastnil1973, sum)
areaRast1973SqKm <- (areaRast1973$area / 1000000)
areaRast1973 <- cbind(areaRast1973, areaRast1973SqKm)
names(areaRast1973) <- c("class", "areaInMeters", "sumArea")

# 1995
vectnil1995 <- vect(nil1995)
emptyRast1995 <- terra::rast(res = 30, xmin = 655224.34214709, xmax = 718286.685853398, ymin = 1230555.09211126, ymax = 1275965.51753469, crs = "+proj=utm +zone=43 +datum=WGS84 +units=m +no_defs")
rastnil1995 <- terra::rasterize(vectnil1995, emptyRast1995, "class")
sz1995 <- cellSize(rastnil1995, unit = "m")
areaRast1995 <- zonal(sz1995, rastnil1995, sum)
areaRast1995SqKm <- (areaRast1995$area / 1000000)
areaRast1995 <- cbind(areaRast1995, areaRast1995SqKm)
names(areaRast1995) <- c("class", "areaInMeters", "sumArea")

# 2017
vectnil2017 <- vect(nil2017)
emptyRast2017 <- terra::rast(res = 30, xmin = 655224.34214709, xmax = 718286.685853398, ymin = 1230555.09211126, ymax = 1275965.51753469, crs = "+proj=utm +zone=43 +datum=WGS84 +units=m +no_defs")
rastnil2017 <- terra::rasterize(vectnil2017, emptyRast2017, "class")
sz2017 <- cellSize(rastnil2017, unit = "m")
areaRast2017 <- zonal(sz2017, rastnil2017, sum)
areaRast2017SqKm <- (areaRast2017$area / 1000000)
areaRast2017 <- cbind(areaRast2017, areaRast2017SqKm)
names(areaRast2017) <- c("class", "areaInMeters", "sumArea")

# resampling rasters to ensure they are all of the same spatial resolution and extent
# We have to do this for the nil1870 and kun1870 rasters

resamNil1870 <- terra::resample(rastnil1870, rastnil1973, method = "near")
sz1870 <- cellSize(resamNil1870, unit = "m")
areaNil1870 <- zonal(sz1870, resamNil1870, sum)
areaNil1870SqKm <- (areaNil1870$area / 1000000)
areaNil1870 <- cbind(areaNil1870, areaNil1870SqKm)

resamKun1870 <- terra::resample(rastkun1870, rastnil1973, method = "near")
sz1870 <- cellSize(resamKun1870, unit = "m")
areaKun1870 <- zonal(sz1870, resamKun1870, sum)
areaKun1870SqKm <- (areaKun1870$area / 1000000)
areaKun1870 <- cbind(areaKun1870, areaKun1870SqKm)

# Joining the nil1870 and kun1870 statistics to get a single table

areaNil1870 <- left_join(areaNil1870, areaKun1870, by = c("class" = "class")) %>%
  filter(!is.na(class)) %>%
  rowwise() %>%
  mutate(sumArea = sum(areaNil1870SqKm, areaKun1870SqKm, na.rm = T)) %>%
  select(class, sumArea)

areaNil1870$class <- c(
  "Shola Forest", "Shola Grassland",
  "Agricultural Land", "Plantations (Tea & Timber)",
  "Settlements", "Water bodies"
)


trial <- mosaic(resamNil1870, resamKun1870)
szt <- cellSize(trial, unit = "m")

area <- zonal(szt, trial, sum)
areasqm <- (area$area / 1000000)
area <- cbind(area, areasqm)
```


Making plots of the overall area of land cover types
```{r}
# Joining all dataframes to create a single one for plotting and visualization
areaCalc <- purrr::reduce(list(
  areaNil1870, areaRast1973, areaRast1995,
  areaRast2017
), dplyr::full_join, by = "class")
names(areaCalc) <- c("class", "1870", "areaMt1973", "1973", "areaMt1995", "1995", "areaMt2017", "2017")

areaCalc <- areaCalc %>%
  select("class", "1870", "1973", "1995", "2017") %>%
  pivot_longer(!class, names_to = "Year", values_to = "Area")

write.csv(areaCalc, "results/totalArea-by-landCover-timePeriod.csv", row.names = F)

# make plot
fig_area <- ggplot(areaCalc, aes(x = class, y = Area, fill = class)) +
  geom_bar(stat = "identity", position = position_dodge(), fill = "#883107", alpha = 0.9) +
  geom_text(aes(label = round(Area), hjust = "middle", vjust = -0.5),
    position = position_dodge(), angle = 0, size = 5
  ) +
  scale_fill_scico_d(palette = "batlow") +
  facet_wrap(~Year) +
  theme_bw() +
  labs(
    x = "\nLand cover type",
    y = "Area in sq.km. \n"
  ) +
  theme(
    axis.title = element_text(
      family = "Century Gothic",
      size = 14, face = "bold"
    ),
    axis.text = element_text(family = "Century Gothic", size = 14),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    legend.position = "none"
  )

ggsave(fig_area,
  filename = "figs/fig_totalArea_landCover.png", width = 15, height = 13,
  device = png(), units = "in", dpi = 300
)
```


Create a figure of proportion of landcover across areas over time
```{r}
# get percentArea occupied by each land cover class
percentArea <- areaCalc %>%
  group_by(Year) %>%
  mutate(
    totalArea = sum(Area, na.rm = T),
    percentArea = (Area / totalArea) * 100
  )

# plot figure
fig_percent_area <- ggplot(percentArea, aes(x = class, y = percentArea, fill = class)) +
  geom_bar(stat = "identity", position = position_dodge(), alpha = 0.9) +
  geom_text(aes(label = round(percentArea, digits = 1), hjust = "middle", vjust = -0.5), position = position_dodge(), angle = 0, size = 5) +
  scale_fill_scico_d(palette = "batlow") +
  facet_wrap(~Year) +
  theme_bw() +
  labs(
    x = "\nLand cover type",
    y = "Percent Area \n"
  ) +
  theme(
    axis.title = element_text(
      family = "Century Gothic",
      size = 14, face = "bold"
    ),
    axis.text = element_text(family = "Century Gothic", size = 14),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    legend.position = "none"
  )

ggsave(fig_percent_area, filename = "figs/fig_percentArea_landCover.png", width = 14, height = 13, device = png(), units = "in", dpi = 300)
```



1. total area by land cover + time Period - DONE
2. Proportion of the landscape occupied by each landcover over time - DONE
2. pathc-level area analysis by land cover + time Period
3. heterogeneity of the land cover data using vegan::diversity() (Auffret et al. 2018)


Questions:

-rasterize & resample to same resolution to compare total area changed across land covers
-keep nil1870 and kun1870 separately and sum by class prior to comaprisons with nil1973, 1995 and 2005




1) What is the total area that has changed across land cover types? (basic change detection)

-total area to be calculated for each polygon
-create column to divide patches into small and large patches ()


2) Landscape-patch based analysis of change - large patch to small patch: 

3) Spatially - regions that have seen maximum change (for which you may need to mosaic/merge rasters?)









