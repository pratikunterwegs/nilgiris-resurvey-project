---
editor_options: 
  chunk_output_type: console
---

# Species relative abundances over time

We replicate analyses following Gotelli et al. 2021 (who provides a methodological approach to calculate relative species abundances using historical museum records) and GÃ³mez et al. 2021 who assumed two scenarios while calculating extinctions and colonizations - "The first is based on the assumption that all surveys accurately describe the avifauna present and that any records of species not detected in prior surveys of San Antonio represent real colonizations. The second scenario is based on the assumption that all the novel species (i.e., those detected for the first time after the 1910s) were false absences."

The second assumption is that the level of the analysis is at the 'historic-site' and not the 'modern-site' (which essentially corresponds to multiple unique modern survey sites for every 'historic-site'). While calculating relative abundances and for estimation of turnover and to ensure that the analysis is consistent, we sum abundances across the modern sites corresponding to each historic site.  

## Load necessary libraries
```{r}
library(dplyr)
library(stringr)
library(tidyverse)
library(scico)
library(RColorBrewer)
library(extrafont)
library(sf)
library(raster)
library(data.table)
library(ggrepel)
library(report)
library(lme4)
library(glmmTMB)
library(multcomp)
library(ggstatsplot)
library(paletteer)

# source custom functions
source("code/02_relative-species-abundance-functions.R")
```

## Load list of resurvey locations

We will load the list of sites across which a modern resurvey was carried out, along with elevation rasters.  
```{r}
# load list of resurvey locations and add elevation as a variable
# remove the modern resurvey locations only (ie. ASFQ)
sites <- read.csv("data/list-of-resurvey-locations.csv")
sites <- sites[-c(1:50),]

# convert to sf object and transform
sites <- st_as_sf(sites, coords = c("longitude", "latitude")) %>%
  `st_crs<-`(4326) %>%
  st_transform(32643)

# add elevation raster
alt <- raster::raster("data/spatial/elevation/alt") # this layer is not added to github as a result of its large size and can be downloaded from SRTM (Farr et al. (2007))

# extract values from that raster (note: transformation of coordinate system)
elev <- raster::extract(alt, sites)
sites <- cbind(sites, elev)
```

## For the historical occurrence data, we will choose data from three time periods: 1850-1900, 1900-1950 and 1950-2000. 
```{r}
## read in historical occurrence data
hist_occ <- read.csv("data/historical-occurrence-data.csv")

### pre-1900
hist_occ_pre1900 <- hist_occ %>%
  filter(year <= 1900)

### fix the count column
hist_occ_pre1900 <-  hist_occ_pre1900 %>%
  mutate(histCount = case_when(individualCount == "X" ~ 1,
                               individualCount == "" ~ 1,
                               TRUE ~ as.numeric(individualCount)))

# calculate total abundance of historical data at each site
hist_occ_count_pre1900 <- hist_occ_pre1900 %>%
  group_by(scientific_name, historical_site_code) %>%
  summarise("1850-1900" = sum(histCount)) 

# left join the sites dataframe
hist_occ_sites_pre1900 <- left_join(hist_occ_count_pre1900, sites, by=c("historical_site_code"="historical_site_code")) %>%
  filter(!is.na(scientific_name)) %>%
  replace(is.na(.), 0) 

## 1900-1950
hist_occ_1900_1950 <- hist_occ %>%
  filter(year > 1900 & year <= 1950)

### fix the count column
hist_occ_1900_1950 <-  hist_occ_1900_1950 %>%
  mutate(histCount = case_when(individualCount == "X" ~ 1,
                               individualCount == "" ~ 1,
                               TRUE ~ as.numeric(individualCount)))

# calculate total abundance of historical data at each site
hist_occ_count_1900_1950 <- hist_occ_1900_1950 %>%
  group_by(scientific_name, historical_site_code) %>%
  summarise("1900-1950" = sum(histCount)) 

# left join the sites dataframe
hist_occ_sites_1900_1950 <- left_join(hist_occ_count_1900_1950, sites, by=c("historical_site_code"="historical_site_code")) %>%
  filter(!is.na(scientific_name)) %>%
  replace(is.na(.), 0) 

## read in modern occurrence data
mod_occ <- read.csv("data/modern-occurrence-data.csv")

## group by scientific name and modern site code
modOcc_spp <- mod_occ %>%
  filter(!is.na(historical_site_code)) %>%
  filter(!is.na(scientific_name)) %>%
  group_by(scientific_name, modern_site_code) %>%
  summarise("2021" = sum(number))

## left join the sites dataframe
mod_occ_sites <-  left_join(modOcc_spp, sites, by=c("modern_site_code"="modern_site_code")) %>%
  filter(!is.na(scientific_name)) %>%
  replace(is.na(.), 0)
```

## Calculate dirichlet distributions of relative abundance

Here, we will functions from Gotelli et al. 2021 to calculate relative species abundances between historic and modern periods. For the first level of analysis, we ignore information at the site-level and calculate overall relative abundance per time-period at the landscape level. 
```{r}
# note: the level of the analysis is at the 'historic-site' and not the 'modern-site' (which essentially corresponds to two or three unique sites for every 'historic-site')
# to ensure that the analysis is consistent, we sum abundances across the modern sites corresponding to each historic site
# However, our analysis calculates relative species abundances for the give time period rather than by site + time-period

## calculating relative species abundances for the time period 1850-1900

# we remove modern site_code and get only distinct rows
unique_hist_pre1900 <- hist_occ_sites_pre1900[,c(1,3)] %>%
  group_by(scientific_name) %>%
  summarise("relAbund1850" = sum(`1850-1900`)) 

# apply dirichlet distribution
dat <- tibble::deframe(unique_hist_pre1900) ## choosing 1850-1900 data

relAbun1850 <- dirch_stats(dat) %>%
  dplyr::select(species, bayes_mean) %>%
  rename(., bayes_mean_1850 = bayes_mean)

## calculating relative species abundances for the time period 1900-1950

# we remove modern site_code and get only distinct rows
unique_hist_1900_1950 <- hist_occ_sites_1900_1950[,c(1,3)] %>%
  group_by(scientific_name) %>%
  summarise("relAbund1900" = sum(`1900-1950`)) 

# apply dirichlet distribution
dat <- tibble::deframe(unique_hist_1900_1950) ## choosing 1900-1950 data

relAbun1900 <- dirch_stats(dat) %>%
  dplyr::select(species, bayes_mean) %>%
  rename(., bayes_mean_1900 = bayes_mean)

## calculating relative species abundances for the modern time period

# we remove modern site_code and get only distinct rows
unique_mod <- mod_occ_sites[,c(1,3)] %>%
  group_by(scientific_name) %>%
  summarise("relAbund2021" = sum(`2021`)) 

# apply dirichlet distribution
dat <- tibble::deframe(unique_mod) ## choosing modern data

relAbun2021 <- dirch_stats(dat) %>%
  dplyr::select(species, bayes_mean) %>%
  rename(., bayes_mean_2021 = bayes_mean)

### join the relative abundance datasets together
relAbun <- full_join(relAbun1850, relAbun1900, by = c("species")) %>%
   full_join(., relAbun2021, by = c("species")) %>%
  replace(is.na(.), 0) %>%
  arrange(species) %>%
  rename(., `1850-1900` = "bayes_mean_1850") %>%
  rename(., `1900-1950` = "bayes_mean_1900") %>%
  rename(., `2021` = "bayes_mean_2021")

## write to file
write.csv(relAbun, "results/species-relative-abundance.csv", row.names = F)
```

## Visualizing changes in relative abundance over time
```{r}
## This analysis is being done at the landscape-level

## one:one comparisons of abundance between 1850-1900 and 2021 (all species and sites pooled)
fig_1850v2021_rel <- ggplot(data=relAbun,aes(x=`2021`,y=`1850-1900`))  + geom_point() +
   scale_y_log10() +
  geom_abline(slope=1, intercept=0,linetype="dashed") +
  scale_x_log10() +
  labs(y = "1850-1900 Relative abundance", 
       x = "2021 Relative abundance") +
   geom_point(shape = 21, colour = "black", fill = "white", size = 2, stroke = 1)+
   geom_smooth(method="lm", se=TRUE, fullrange=FALSE, level=0.95,linetype="solid") +  theme_bw() +
  theme(axis.text = element_text(family = "Century Gothic", size = 13),
        legend.title = element_text(family = "Century Gothic"),
    legend.text = element_text(family = "Century Gothic"),
    text = element_text(family = "Century Gothic", size = 25))

ggsave(fig_1850v2021_rel, filename = "figs/fig_1850-1900vs2021_relAbun.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)

## violinplot
data_for_violinplot <- relAbun %>%
  dplyr::select(-species) %>%
  pivot_longer(everything())

fig_relAbun_over_time <- ggbetweenstats(
  data = data_for_violinplot,
  x = name,
  y = value,
  xlab = "Time Period", 
  ylab = "Relative Abundance",
  title = "Relative abundance by time period",
  plot.type = "boxviolin",
  pairwise.comparisons = T) +
  scale_y_log10() +
  scale_color_manual(values = c("#9EB0FFFF", "#122C39FF","#D5857DFF")) +   theme(plot.title = element_text(family = "Century Gothic",
      size = 18, face = "bold"),
    axis.title = element_text(family = "Century Gothic",
      size = 16, face = "bold"),
        axis.text = element_text(family="Century Gothic",size = 14),
      plot.subtitle = element_text(
      family = "Century Gothic", 
      size = 14, 
      face = "bold",
      color="#1b2838"
    ))

ggsave(fig_relAbun_over_time, filename = "figs/fig_relAbun_landscapeLevel.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)
dev.off()
```

## Visualization as a line plot (for each species)
```{r}
## subset data for line plots
relAbun_forLinePlot <- relAbun %>%
  pivot_longer(-species, names_to = "timePeriod", values_to = "relAbun") %>%
  filter(relAbun != 0) 

## ensure that text does not overlap
options(ggrepel.max.overlaps = Inf)

# fig
fig_relAbun_linePlot <- ggplot(relAbun_forLinePlot, aes(x=timePeriod, y = relAbun,color = species, group = species)) +
  geom_point() + 
  geom_line() +
  geom_text_repel(data=subset(relAbun_forLinePlot, timePeriod == "2021"),
            aes(timePeriod,relAbun,label=species)) +
  scale_y_log10() +
  xlab("Time period") +
  ylab("Relative abundance") +
  scale_color_scico_d(palette = "grayC", begin = 1, end = 1) +
  theme_bw() +
  theme(axis.text = element_text(family = "Century Gothic", size = 13),
        legend.title = element_text(family = "Century Gothic"),
    legend.text = element_text(family = "Century Gothic"),
    text = element_text(family = "Century Gothic", size = 25)) +
  guides(fill="none",
         color = "none")

ggsave(fig_relAbun_linePlot, filename = "figs/fig_relAbun_linePlot.png", width = 18, height = 15, device = png(), units = "in", dpi = 300)
```

## Examining changes in relative abundance as a function of species habitat affiliation

Let's first curate the species trait data
```{r}
## load state of India's birds data to get habitat affiliation
species_codes <- read.csv("data/species-codes.csv")
habitat_SoIB <- read.csv("data/2022-SoIB-habitat-data.csv") # note: we used two files - one file from 2020 and an updated habitat specialization file from 2022 (see below)

# join the two dataframes
habitat_dat <- left_join(species_codes, habitat_SoIB, by=c("scientific_name"="scientific_name"))

# write the above to data folder and recode habitat affiliation
# write.csv(habitat_dat, "data/species-trait-dat.csv", row.names = F)

# note: the classification of habitat type was taken from a working file of trait data for State of India's Birds report v2 (to be released in 2023). We used the following trait classifications:
# Wooded habitat: If it preferred some level of wooded habitat but not particularly specialized on rainforest/forest habitat. An example in this case is the black and orange flycatcher. While it is commonly found in shola forest habitat, this species is also common in degraded wooded areas, including timber plantations. If a species preferred just scrub habitat alone, we lumped it under this category.
# Forest: If a species was a forest specialist. 
# Grassland: While State of India's birds uses a separate classification for grassland & grassland+scrub, here we combine the two and use a single classification for Grassland. Eg. Black drongo - which favors both grassland areas and scrub habitat. There are four species that are classified as using 'open habitat' which had been subsumed under grasslands in our study - this includes - blue-tailed bee-eater, black-winged kite, long-tailed shrike (eBird lists it as preferring open habitats) and western yellow wagtail. 
# Generalist: If a species is truly a generalist species and is not particularly occupying/specialized on any particular wooded/forested/grassland habitat.

## load the species trait data (that includes habitat) and merge with the AVONET dataset
## please note that it is being loaded after curating and adding a column for habitat type based on our understanding of species natural history
hab_dat <- read.csv("data/species-habitat-dat.csv")
avonet <- read.csv("data/AVONET-data.csv")

# join the above two datasets
trait_dat <- left_join(hab_dat, avonet[,c(1,10:20,29:31)], by=c("scientific_name"="Species2"))

## Write the trait data to file
## write.csv(trait_dat,"data/species-trait-dat.csv",row.names = F)
```

## Join datasets of relative abundance and species trait
```{r}
## load this in if you have already run the previous chunk of code
trait_dat <- read.csv("data/species-trait-dat.csv")

## join rel abun and species trait
## pivot longer
rel_abun_trait <- relAbun %>%
  pivot_longer(-species, names_to = "Time Period", values_to = "Relative abundance") %>% left_join(., trait_dat, by=c("species"="scientific_name")) %>%
   filter(Habitat.type != "Aquatic") %>%
  filter(`Relative abundance` !=0) %>%
  ungroup()
  
# visualization by habitat affiliation
rel_abun_trait$Habitat.type <- factor(rel_abun_trait$Habitat.type, levels=c("Forest", "Grassland", "Generalist", "Wooded Habitat"))

# log transformation of relative abundance to avoid negative values
rel_abun_trait$log_relative_abundance <- log10(rel_abun_trait$`Relative abundance` + 1 - min(rel_abun_trait$`Relative abundance`))

fig_relAbun_habitat <- grouped_ggbetweenstats(
  data = rel_abun_trait,
  x = `Time Period`,
  y = log_relative_abundance,
  grouping.var = `Habitat.type`,
  xlab = "Habitat.type", 
  ylab = "Relative Abundance",
  p.adjust.method = "fdr",
  #title = "Relative abundance by habitat type",
  plot.type = "boxviolin",
  ggplot.component = list(ggplot2::scale_y_continuous(
    breaks = seq(0, 0.04, 0.005),
    limits = (c(0, 0.04))))) +
  scale_fill_scico_d(palette = "roma") 

ggsave(fig_relAbun_habitat, filename = "figs/fig_relAbun_habitat_landscapeLevel.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)
dev.off()

## examining relative species abundance and body mass
## faceting by time period
fig_relAbun_mass <- ggplot(rel_abun_trait, aes(x= Mass, y=`Relative abundance`)) +  geom_point(shape = 21, colour = "black", fill = "white", size = 2, stroke = 1)+
   geom_smooth(method="lm", se=TRUE, fullrange=FALSE, level=0.95,linetype="solid") +  
  theme_bw() +
    scale_y_log10() +
   stat_regline_equation(label.y = 0.100, aes(label = ..eq.label..)) +
  stat_regline_equation(label.y = 0.500, aes(label = ..rr.label..)) +
  scale_x_log10() +
  facet_wrap(~`Time Period`) +
  labs(x="\nlog (Body mass)", 
       y="Relative abundance\n") +
  theme(axis.text = element_text(family = "Century Gothic", size = 13),
        legend.title = element_text(family = "Century Gothic"),
    legend.text = element_text(family = "Century Gothic"),
    text = element_text(family = "Century Gothic", size = 25))

ggsave(fig_relAbun_mass, filename = "figs/fig_relAbun_bodyMass.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)

## hand-wing index
fig_relAbun_hwi <- ggplot(rel_abun_trait, aes(x= Hand.Wing.Index, y=`Relative abundance`)) +  
  geom_point(shape = 21, colour = "black", fill = "white", size = 2, stroke = 1)+
   geom_smooth(method="lm", se=TRUE, fullrange=FALSE, level=0.95,linetype="solid") +  theme_bw() +
    scale_y_log10() +
  stat_regline_equation(label.y = 0.100, aes(label = ..eq.label..)) +
  stat_regline_equation(label.y = 0.500, aes(label = ..rr.label..)) +
  facet_wrap(~`Time Period`) +
  labs(x="\nHand-Wing Index", 
       y="Relative abundance\n") +
  theme(axis.text = element_text(family = "Century Gothic", size = 13),
        legend.title = element_text(family = "Century Gothic"),
    legend.text = element_text(family = "Century Gothic"),
    text = element_text(family = "Century Gothic", size = 25))

ggsave(fig_relAbun_hwi, filename = "figs/fig_relAbun_handWingIndex.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)
```

## Repeating the above analysis at the site-level
```{r}
# we remove modern site_code and get only distinct rows
hist_pre1900 <- hist_occ_sites_pre1900[,c(1:3)] %>%
  distinct(.)

relSpAbund_1850_1900 <- c()

for(i in 1:length(unique(hist_pre1900$historical_site_code))) {
  
  a <- hist_pre1900 %>%
  filter(historical_site_code == unique(hist_pre1900$historical_site_code)[i])

  b <- tibble::deframe(a[,c(1,3)]) ## choosing 1850-1900 data
  
  loc <- unique(hist_pre1900$historical_site_code)[i] # what's the site_code?
  
  relSpAbund_1850_1900[[i]] <- dirch_stats(b) %>%
  dplyr::select(species, bayes_mean)

  old_varname <-  c('species','bayes_mean')
  new_varname <- c('scientific_name', paste(loc,"_","1850", sep = ""))

  relSpAbund_1850_1900[[i]] <- relSpAbund_1850_1900[[i]] %>%
      data.table::setnames(old = old_varname, new = new_varname)

  names(relSpAbund_1850_1900)[i] <- loc 
}

# save object but full_join across lists
relSpAbund_1850_1900 <- relSpAbund_1850_1900 %>%
    reduce(.f=full_join)

## repeating the above across other time periods
##  time period 1900-1950

# we remove modern site_code and get only distinct rows
hist_1900_1950 <- hist_occ_sites_1900_1950[,c(1:3)] %>%
  distinct(.)

relSpAbund_1900_1950 <- c()

for(i in 1:length(unique(hist_1900_1950$historical_site_code))) {
  
  a <- hist_1900_1950 %>%
  filter(historical_site_code == unique(hist_1900_1950$historical_site_code)[i])

  b <- tibble::deframe(a[,c(1,3)]) ## choosing 1900-1950 data
  
  loc <- unique(hist_1900_1950$historical_site_code)[i] # what's the site_code?
  
  relSpAbund_1900_1950[[i]] <- dirch_stats(b) %>%
  dplyr::select(species, bayes_mean)

  old_varname <-  c('species','bayes_mean')
  new_varname <- c('scientific_name', paste(loc,"_","1900", sep = ""))

  relSpAbund_1900_1950[[i]] <- relSpAbund_1900_1950[[i]] %>%
      data.table::setnames(old = old_varname, new = new_varname)

  names(relSpAbund_1900_1950)[i] <- loc 
}

# save object but full_join across lists
relSpAbund_1900_1950 <- relSpAbund_1900_1950 %>%
    reduce(.f=full_join)

##  time period 2021
mod_2021 <- mod_occ_sites[,c(1,3,5)] %>%
  group_by(scientific_name, historical_site_code) %>%
  mutate("2021" = sum(`2021`)) %>%
  distinct(.)

relSpAbund_2021 <- c()

for(i in 1:length(unique(mod_2021$historical_site_code))) {
  
  a <- mod_2021 %>%
  filter(historical_site_code == unique(mod_2021$historical_site_code)[i])

  b <- tibble::deframe(a[,c(1,2)]) ## choosing modern data
  
  loc <- unique(mod_2021$historical_site_code)[i] # what's the site_code?
  
  relSpAbund_2021[[i]] <- dirch_stats(b) %>%
  dplyr::select(species, bayes_mean)

  old_varname <-  c('species','bayes_mean')
  new_varname <- c('scientific_name', paste(loc,"_","2021", sep = ""))

  relSpAbund_2021[[i]] <- relSpAbund_2021[[i]] %>%
      data.table::setnames(old = old_varname, new = new_varname)

  names(relSpAbund_2021)[i] <- loc 
}

# save object but full_join across lists
relSpAbund_2021 <- relSpAbund_2021 %>%
    reduce(.f=full_join)

## join all the datasets together
relSpAbund_by_site <- full_join(relSpAbund_1850_1900, relSpAbund_1900_1950, by = "scientific_name") %>%
  full_join(., relSpAbund_2021, by = "scientific_name") %>%
  arrange(scientific_name) %>%
  replace(is.na(.), 0) 
```

## Visualizing differences in relative abundance over time at the site level
```{r}
## preparing dataframe for visualization
relSpAbund <- relSpAbund_by_site %>%
  pivot_longer(!scientific_name, names_to = "site_year", values_to = "relAbundance") %>%
  separate(site_year, into = c("site", "year"), sep = "_") %>%
  filter(relAbundance != 0)

## write results to file
write.csv(relSpAbund, "results/species-relative-abundance-siteLevel.csv", row.names = F)

## Please note: for the sake of downstream analysis, we have renamed 1850-1900 as 1850, 1900-1950 as 1900. In other words, each year - except for 2021 represents a 50 year time period. 

fig_relAbun_siteLevel <- relSpAbund %>%
  dplyr::select(-scientific_name) %>%
  ggplot(aes(x=year, y = relAbundance,
             fill = year)) +
  geom_boxplot() +
  scale_y_log10() +
  facet_wrap(~site)+
  xlab("Time period") +
  ylab("Relative abundance") +
  scale_fill_scico_d(palette = "batlow") +
  theme_bw() +
  theme(axis.title = element_text(family = "Century Gothic",
      size = 14, face = "bold"),
        axis.text = element_text(family="Century Gothic",size = 14),
      legend.title = element_text(family="Century Gothic",
                                    size = 14, face = "bold"),
        legend.key.size = unit(1,"cm"),
        legend.text = element_text(family="Century Gothic",size = 14)) +
  guides(fill="none")

ggsave(fig_relAbun_siteLevel, filename = "figs/fig_relAbun_siteLevel.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)

## examining species relative abundance and elevation

names(relSpAbund) <- c("scientific_name","historical_site_code","year","relAbundance")

relAbun_elev <- left_join(relSpAbund, sites, by=c("historical_site_code"="historical_site_code"))

## visualization of relative abundance and elevation
fig_relAbun_elev <- ggplot(relAbun_elev, aes(x= elev, y=relAbundance)) +  
  geom_point(shape = 21, colour = "black", fill = "white", size = 2, stroke = 1)+
   geom_smooth(method="lm", se=TRUE, fullrange=FALSE, level=0.95,linetype="solid") +  theme_bw() +
    scale_y_log10() +
  facet_wrap(~year) +
  labs(x="\nElevation (in meters)", 
       y="Relative abundance\n") +
  theme(axis.text = element_text(family = "Century Gothic", size = 13),
        legend.title = element_text(family = "Century Gothic"),
    legend.text = element_text(family = "Century Gothic"),
    text = element_text(family = "Century Gothic", size = 25))

ggsave(fig_relAbun_elev, filename = "figs/fig_relAbun_elev.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)

## join relative abundance at site level with trait data
relAbun_Hab <- left_join(relSpAbund, trait_dat, by="scientific_name") %>% 
  left_join(., sites, by = "historical_site_code") %>%
  filter(Habitat.type != "Aquatic") %>%
  ungroup()
```

## Running generalized linear mixed models
```{r}
## overall
relSpAbund <- relSpAbund %>%
  mutate(relAbundance = case_when(relAbundance == 1 ~ 0.999,
                                  TRUE ~ relAbundance))

glmm_overall <- glmmTMB(relAbundance ~ year + (1|historical_site_code) +(1|scientific_name),
                      data = relSpAbund, 
                      ziformula = ~1,
                      family = beta_family(link = "logit"))

summary(glmm_overall)
```
Family: beta  ( logit )
Formula:          
relAbundance ~ year + (1 | historical_site_code) + (1 | scientific_name)
Zero inflation:                ~1
Data: relSpAbund

     AIC      BIC   logLik deviance df.resid 
 -6138.7  -6101.8   3076.3  -6152.7     1431 

Random effects:

Conditional model:
 Groups               Name        Variance Std.Dev.
 historical_site_code (Intercept) 0.11086  0.333   
 scientific_name      (Intercept) 0.03424  0.185   
Number of obs: 1438, groups:  
historical_site_code, 28; scientific_name, 189

Dispersion parameter for beta family (): 24.2 

Conditional model:
            Estimate Std. Error z value Pr(>|z|)    
(Intercept) -2.84631    0.09978 -28.524  < 2e-16 ***
year1900     0.53369    0.08813   6.056 1.40e-09 ***
year2021    -0.34634    0.08896  -3.893 9.88e-05 ***
---
Signif. codes:  0 â***â 0.001 â**â 0.01 â*â 0.05 â.â 0.1 â â 1

Zero-inflation model:
            Estimate Std. Error z value Pr(>|z|)
(Intercept)   -21.97    1554.15  -0.014    0.989


```{r}
## habitat affiliation
relAbun_Hab<- relAbun_Hab %>%
  mutate(relAbundance = case_when(relAbundance == 1 ~ 0.999,
                                  TRUE ~ relAbundance))

forest_glmm <- relAbun_Hab %>%
  filter(Habitat.type == "Forest")

glmm_forest <- glmmTMB(relAbundance ~ year + (1|historical_site_code) +(1|scientific_name),
                      data = forest_glmm, 
                      ziformula = ~1,
                      family = beta_family(link = "logit"))
  
summary(glmm_forest)
```
Family: beta  ( logit )
Formula:          
relAbundance ~ year + (1 | historical_site_code) + (1 | scientific_name)
Zero inflation:                ~1
Data: forest_glmm

     AIC      BIC   logLik deviance df.resid 
 -3166.6  -3136.3   1590.3  -3180.6      554 

Random effects:

Conditional model:
 Groups               Name        Variance Std.Dev.
 historical_site_code (Intercept) 0.22098  0.4701  
 scientific_name      (Intercept) 0.05486  0.2342  
Number of obs: 561, groups:  
historical_site_code, 28; scientific_name, 41

Dispersion parameter for beta family ():  120 

Conditional model:
            Estimate Std. Error z value Pr(>|z|)    
(Intercept) -3.15392    0.11906 -26.491  < 2e-16 ***
year1900     0.46965    0.07368   6.374 1.84e-10 ***
year2021    -0.84798    0.07540 -11.247  < 2e-16 ***
---
Signif. codes:  0 â***â 0.001 â**â 0.01 â*â 0.05 â.â 0.1 â â 1

Zero-inflation model:
            Estimate Std. Error z value Pr(>|z|)
(Intercept)   -22.18    2760.70  -0.008    0.994

```{r}
grassland_glmm <- relAbun_Hab %>%
  filter(Habitat.type == "Grassland")

glmm_grassland <- glmmTMB(relAbundance ~ year + (1|historical_site_code) +(1|scientific_name),
                      data = grassland_glmm, 
                      ziformula = ~1,
                      family = beta_family(link = "logit"))

summary(glmm_grassland)
```
Family: beta  ( logit )
Formula:          
relAbundance ~ year + (1 | historical_site_code) + (1 | scientific_name)
Zero inflation:                ~1
Data: grassland_glmm

     AIC      BIC   logLik deviance df.resid 
  -627.8   -606.2    320.9   -641.8      154 

Random effects:

Conditional model:
 Groups               Name        Variance Std.Dev.
 historical_site_code (Intercept) 1.7836   1.3355  
 scientific_name      (Intercept) 0.5294   0.7276  
Number of obs: 161, groups:  
historical_site_code, 24; scientific_name, 24

Dispersion parameter for beta family (): 29.6 

Conditional model:
            Estimate Std. Error z value Pr(>|z|)    
(Intercept)  -1.6477     0.4126  -3.993 6.51e-05 ***
year1900     -1.0198     0.2841  -3.589 0.000331 ***
year2021     -3.0342     0.4910  -6.180 6.40e-10 ***
---
Signif. codes:  0 â***â 0.001 â**â 0.01 â*â 0.05 â.â 0.1 â â 1

Zero-inflation model:
            Estimate Std. Error z value Pr(>|z|)
(Intercept)    -22.4     5767.3  -0.004    0.997

```{r}
wooded_glmm <- relAbun_Hab %>%
  filter(Habitat.type == "Wooded Habitat")

glmm_wooded <- glmmTMB(relAbundance ~ year + (1|historical_site_code) +(1|scientific_name),
                      data = wooded_glmm, 
                      ziformula = ~1,
                      family = beta_family(link = "logit"))

summary(glmm_wooded)
```
Family: beta  ( logit )
Formula:          
relAbundance ~ year + (1 | historical_site_code) + (1 | scientific_name)
Zero inflation:                ~1
Data: wooded_glmm

     AIC      BIC   logLik deviance df.resid 
 -4574.6  -4540.3   2294.3  -4588.6      991 

Random effects:

Conditional model:
 Groups               Name        Variance Std.Dev.
 historical_site_code (Intercept) 0.1868   0.4322  
 scientific_name      (Intercept) 0.1037   0.3221  
Number of obs: 998, groups:  
historical_site_code, 28; scientific_name, 75

Dispersion parameter for beta family (): 34.9 

Conditional model:
            Estimate Std. Error z value Pr(>|z|)    
(Intercept) -2.93976    0.12528 -23.466  < 2e-16 ***
year1900     0.42879    0.09269   4.626 3.72e-06 ***
year2021    -0.56421    0.10799  -5.225 1.75e-07 ***
---
Signif. codes:  0 â***â 0.001 â**â 0.01 â*â 0.05 â.â 0.1 â â 1

Zero-inflation model:
            Estimate Std. Error z value Pr(>|z|)
(Intercept)    -22.2     2097.8  -0.011    0.992

```{r}
generalist_glmm <- relAbun_Hab %>%
  filter(Habitat.type == "Generalist")

glmm_generalist <- glmmTMB(relAbundance ~ year + (1|historical_site_code) +(1|scientific_name),
                      data = generalist_glmm, 
                      ziformula = ~1,
                      family = beta_family(link = "logit"))

summary(glmm_generalist)
```

Family: beta  ( logit )
Formula:          
relAbundance ~ year + (1 | historical_site_code) + (1 | scientific_name)
Zero inflation:                ~1
Data: generalist_glmm

     AIC      BIC   logLik deviance df.resid 
 -3851.3  -3818.8   1932.6  -3865.3      750 

Random effects:

Conditional model:
 Groups               Name        Variance Std.Dev.
 historical_site_code (Intercept) 0.1356   0.3683  
 scientific_name      (Intercept) 0.1964   0.4432  
Number of obs: 757, groups:  
historical_site_code, 28; scientific_name, 47

Dispersion parameter for beta family (): 68.5 

Conditional model:
            Estimate Std. Error z value Pr(>|z|)    
(Intercept) -3.61257    0.12888 -28.031   <2e-16 ***
year1900     0.88942    0.08892  10.003   <2e-16 ***
year2021     0.15838    0.08719   1.817   0.0693 .  
---
Signif. codes:  0 â***â 0.001 â**â 0.01 â*â 0.05 â.â 0.1 â â 1

Zero-inflation model:
            Estimate Std. Error z value Pr(>|z|)
(Intercept)   -22.22    2424.67  -0.009    0.993

## Visualizing relative abundance across time periods as function of elevation and habitat type
```{r}
# run by habitat type for year 1850
relAbunHab1850 <- relAbun_Hab %>%
  filter(year == 1850)

fig_relAbun_hab1850 <- ggplot(relAbunHab1850, aes(x=elev,y=relAbundance)) +  
  geom_point(shape = 21, colour = "black", fill = "white", size = 2, stroke = 1)+
   geom_smooth(method="lm", se=TRUE, fullrange=FALSE, level=0.95,linetype="solid") +  theme_bw() +
    scale_y_log10() +
  facet_wrap(~Habitat.type) +
  labs(x="\nElevation (in meters)", 
       y="Relative Abundance\n") +
  theme(axis.text = element_text(family = "Century Gothic", size = 13),
        legend.title = element_text(family = "Century Gothic"),
    legend.text = element_text(family = "Century Gothic"),
    text = element_text(family = "Century Gothic", size = 25))

ggsave(fig_relAbun_hab1850, filename = "figs/fig_relAbun_elev_habitat1850.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)

# run by habitat type for year 2021
relAbunHab2021 <- relAbun_Hab %>%
  filter(year == 2021)

fig_relAbun_hab2021 <- ggplot(relAbunHab2021, aes(x=elev,y=relAbundance)) +  
  geom_point(shape = 21, colour = "black", fill = "white", size = 2, stroke = 1)+
   geom_smooth(method="lm", se=TRUE, fullrange=FALSE, level=0.95,linetype="solid") +  theme_bw() +
  scale_y_log10() +
  facet_wrap(~Habitat.type) +
  labs(x="\nElevation (in meters)", 
       y="Relative Abundance\n") +
  theme(axis.text = element_text(family = "Century Gothic", size = 13),
        legend.title = element_text(family = "Century Gothic"),
    legend.text = element_text(family = "Century Gothic"),
    text = element_text(family = "Century Gothic", size = 25))

ggsave(fig_relAbun_hab2021, filename = "figs/fig_relAbun_elev_habitat2021.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)
```

