---
editor_options: 
  chunk_output_type: console
---

# Species relative abundances over time

We replicate analyses following Gotelli et al. 2021 (who provides a methodological approach to calculate relative species abundances using historical museum records) and GÃ³mez et al. 2021 who assumed two scenarios while calculating extinctions and colonizations - "The first is based on the assumption that all surveys accurately describe the avifauna present and that any records of species not detected in prior surveys of San Antonio represent real colonizations. The second scenario is based on the assumption that all the novel species (i.e., those detected for the first time after the 1910s) were false absences."

The second assumption is that the level of the analysis is at the 'historic-site' and not the 'modern-site' (which essentially corresponds to multiple unique modern survey sites for every 'historic-site'). While calculating relative abundances and for estimation of turnover and to ensure that the analysis is consistent, we sum abundances across the modern sites corresponding to each historic site.  

## Load necessary libraries
```{r}
library(dplyr)
library(stringr)
library(tidyverse)
library(scico)
library(RColorBrewer)
library(extrafont)
library(sf)
library(raster)
library(lattice)
library(data.table)
library(ggrepel)
library(report)
library(lme4)
library(glmmTMB)
library(multcomp)
library(ggstatsplot)
library(paletteer)
library(ggpubr)
library(goeveg)
library(sjPlot)
library(patchwork)

# source custom functions
source("code/02_relative-species-abundance-functions.R")
```

## Load list of resurvey locations

We will load the list of sites across which a modern resurvey was carried out, along with elevation rasters.  
```{r}
# load list of resurvey locations and add elevation as a variable
# remove the modern resurvey locations only (ie. ASFQ)
sites <- read.csv("data/list-of-resurvey-locations.csv")
sites <- sites[-c(1:50),]

# convert to sf object and transform
sites <- st_as_sf(sites, coords = c("longitude", "latitude")) %>%
  `st_crs<-`(4326) %>%
  st_transform(32643)

# add elevation raster
alt <- raster::raster("data/spatial/elevation/alt") # this layer is not added to github as a result of its large size and can be downloaded from SRTM (Farr et al. (2007))

# extract values from that raster (note: transformation of coordinate system)
elev <- raster::extract(alt, sites)
sites <- cbind(sites, elev)
```

## For the historical occurrence data, we will choose data from a single time period: 1850-1900
```{r}
## read in historical occurrence data
hist_occ <- read.csv("results/histSubset.csv")

## remove species with few observations
histCount <- hist_occ %>%
  group_by(scientific_name) %>%
  count() 

## filter species list with a minimum of ten records
histCount_minTen <- histCount %>%
  filter(n >= 10 )

## filter species to include only 35 species
hist_occ <- hist_occ %>%
  filter(scientific_name %in% histCount_minTen$scientific_name)

# calculate total abundance of historical data at each site
hist_occ <- hist_occ %>%
  group_by(scientific_name, historical_site_code) %>%
  count() %>%
  summarise("1850-1900" = sum(n)) 

# left join the sites dataframe
hist_occ <- left_join(hist_occ, sites, by=c("historical_site_code"="historical_site_code")) %>%
  filter(!is.na(scientific_name)) %>%
  replace(is.na(.), 0) 

## read in modern occurrence data
mod_occ <- read.csv("results/modSubset.csv")

## group by scientific name and modern site code
mod_occ <- mod_occ %>%
  filter(!is.na(historical_site_code)) %>%
  filter(!is.na(scientific_name)) %>%
  group_by(scientific_name, modern_site_code) %>%
  summarise("2021" = sum(number))

## left join the sites dataframe
mod_occ <-  left_join(mod_occ, sites, by=c("modern_site_code"="modern_site_code")) %>%
  filter(!is.na(scientific_name)) %>%
  replace(is.na(.), 0)
```

## Calculate dirichlet distributions of relative abundance

Here, we will functions from Gotelli et al. 2021 to calculate relative species abundances between historic and modern periods. For the first level of analysis, we ignore information at the site-level and calculate overall relative abundance per time-period at the landscape level. 
```{r}
# note: the level of the analysis is at the 'historic-site' and not the 'modern-site' (which essentially corresponds to two or three unique sites for every 'historic-site')
# to ensure that the analysis is consistent, we sum abundances across the modern sites corresponding to each historic site
# However, our analysis calculates relative species abundances for the give time period rather than by site + time-period

## calculating relative species abundances for the time period 1850-1900

# we remove modern site_code and get only distinct rows
unique_hist <- hist_occ[,c(1,2,3)] %>%
  group_by(scientific_name, historical_site_code) %>%
  distinct() %>%
  group_by(scientific_name) %>%
  summarise("relAbund1850" = sum(`1850-1900`)) 

# apply dirichlet distribution
dat <- tibble::deframe(unique_hist) ## choosing 1850-1900 data

relAbun1850 <- dirch_stats(dat) %>%
  dplyr::select(species, bayes_mean) %>%
  rename(., bayes_mean_1850 = bayes_mean)

## calculating relative species abundances for the modern time period

# we remove modern site_code and get only distinct rows
unique_mod <- mod_occ[,c(1,3,5)] %>%
  group_by(scientific_name, historical_site_code) %>%
  distinct() %>%
  group_by(scientific_name) %>%
  summarise("relAbund2021" = sum(`2021`)) 

# apply dirichlet distribution
dat <- tibble::deframe(unique_mod) ## choosing modern data

relAbun2021 <- dirch_stats(dat) %>%
  dplyr::select(species, bayes_mean) %>%
  rename(., bayes_mean_2021 = bayes_mean)

### join the relative abundance datasets together
relAbun <- full_join(relAbun1850, relAbun2021, by = c("species")) %>%
  replace(is.na(.), 0) %>%
  arrange(species) %>%
  rename(., `1850-1900` = "bayes_mean_1850") %>%
  rename(., `2021` = "bayes_mean_2021") %>%
  rename(., scientific_name = species)

## write to file
write.csv(relAbun, "results/species-relative-abundance.csv", row.names = F)
```


## Visualizing changes in relative abundance over time
```{r}
## This analysis is being done at the landscape-level

## one:one comparisons of abundance between 1850-1900 and 2021 (all species and sites pooled)
fig_1850v2021_rel <- ggplot(data=relAbun,aes(x=`2021`,y=`1850-1900`))  + geom_point() +
   scale_y_log10() +
  geom_abline(slope=1, intercept=0,linetype="dashed") +
  scale_x_log10() +
  labs(y = "1850-1900 Relative abundance", 
       x = "2021 Relative abundance") +
   geom_point(shape = 21, colour = "black", fill = "white", size = 2, stroke = 1)+
   geom_smooth(method="lm", se=TRUE, fullrange=FALSE, level=0.95,linetype="solid")+
  theme_bw() +
  theme(axis.text = element_text(family = "Century Gothic", size = 13),
        legend.title = element_text(family = "Century Gothic"),
    legend.text = element_text(family = "Century Gothic"),
    text = element_text(family = "Century Gothic", size = 25))

ggsave(fig_1850v2021_rel, filename = "figs/fig_1850-1900vs2021_relAbun.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)
dev.off()

## violinplot
data_for_violinplot <- relAbun %>%
  dplyr::select(-scientific_name) %>%
  pivot_longer(everything())

fig_relAbun_over_time <- ggbetweenstats(
  data = data_for_violinplot,
  x = name,
  y = value,
  xlab = "Time Period", 
  ylab = "Relative Abundance",
  title = "Relative abundance by time period",
  plot.type = "box",
  pairwise.comparisons = T) +
  scale_y_log10() +
  scale_color_manual(values = c("#9EB0FFFF", "#122C39FF","#D5857DFF")) +   theme(plot.title = element_text(family = "Century Gothic",
      size = 18, face = "bold"),
    axis.title = element_text(family = "Century Gothic",
      size = 16, face = "bold"),
        axis.text = element_text(family="Century Gothic",size = 14),
      plot.subtitle = element_text(
      family = "Century Gothic", 
      size = 14, 
      face = "bold",
      color="#1b2838"
    ))

ggsave(fig_relAbun_over_time, filename = "figs/fig_relAbun_landscapeLevel.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)
dev.off()
```

## Visualization as a line plot (for each species)
```{r}
## subset data for line plots
relAbun_forLinePlot <- relAbun %>%
  pivot_longer(-scientific_name, names_to = "timePeriod", values_to = "relAbun") %>% filter(relAbun != 0) 

## ensure that text does not overlap
options(ggrepel.max.overlaps = Inf)

# fig
fig_relAbun_linePlot <- ggplot(relAbun_forLinePlot, aes(x=timePeriod, y = relAbun,color = scientific_name, group = scientific_name)) +
  geom_point() + 
  geom_line() +
  geom_text_repel(data=subset(relAbun_forLinePlot, timePeriod == "2021"),
            aes(timePeriod,relAbun,label=scientific_name)) +
  scale_y_log10() +
  xlab("Time period") +
  ylab("Relative abundance") +
  scale_color_scico_d(palette = "grayC", begin = 1, end = 1) +
  theme_bw() +
  theme(axis.text = element_text(family = "Century Gothic", size = 13),
        legend.title = element_text(family = "Century Gothic"),
    legend.text = element_text(family = "Century Gothic"),
    text = element_text(family = "Century Gothic", size = 25)) +
  guides(fill="none",
         color = "none")

ggsave(fig_relAbun_linePlot, filename = "figs/fig_relAbun_linePlot.png", width = 18, height = 15, device = png(), units = "in", dpi = 300)
dev.off()
```

## Rank abundance curves of relative abundance for two time periods  

```{r}
## historical data
rank_1850 <- relAbun[c(1,2)] %>%
  pivot_wider(names_from = scientific_name,
              values_from = `1850-1900`,
              values_fill = list(`1850-1900`=0))

rank_1850_mat <- as.matrix(rank_1850[, 1:ncol(rank_1850)])

# dataframe for visualization of rank abundance for historical data
freq <- sort(apply(rank_1850_mat > 0, 2, sum), decreasing = T)
abund <- sort(apply(rank_1850_mat, 2, sum), decreasing = T)
sum(abund)
rel_abund_hist <- sort((abund/sum(abund)), decreasing = T)
labels.abund <- names(rel_abund_hist)
rel_abund_hist <- data.frame(names(rel_abund_hist),data.frame(rel_abund_hist))
names(rel_abund_hist) <- c("scientific_name","rel_abund")
rel_abund_hist$year <- 1850

## repeat the above for modern occurrence
rank_2021 <- relAbun[c(1,3)] %>%
  pivot_wider(names_from = scientific_name,
              values_from = `2021`,
              values_fill = list(`2021`=0))

rank_2021_mat <- as.matrix(rank_2021[, 1:ncol(rank_2021)])

# dataframe for visualization of rank abundance for modern data
freq <- sort(apply(rank_2021_mat > 0, 2, sum), decreasing = T)
abund <- sort(apply(rank_2021_mat, 2, sum), decreasing = T)
sum(abund)
rel_abund_mod <- sort((abund/sum(abund)), decreasing = T)
#labels.abund <- names(rel_abund_hist)
rel_abund_mod <- data.frame(names(rel_abund_mod),data.frame(rel_abund_mod))
names(rel_abund_mod) <- c("scientific_name","rel_abund")
rel_abund_mod$year <- 2021

# visualization
rank_abund_dat <- full_join(rel_abund_hist, rel_abund_mod)
rank_abund_dat$year <- as.factor(rank_abund_dat$year)

# historical
fig_rankAbund <- ggplot(rank_abund_dat, aes(x = reorder(scientific_name,-rel_abund), y = rel_abund, fill = year)) + geom_bar(stat = "identity", position = "identity", alpha = 0.6) + scale_fill_manual(values = c("#2c7fb8","#e34a33")) +
  ylim(0,0.2) + 
  theme_bw() +
  labs(
    x = "\nScientific name",
    y = "Relative abundance\n"
  ) +
  theme(
    axis.title = element_text(
      family = "Century Gothic",
      size = 14, face = "bold"
    ),
    axis.text = element_text(family = "Century Gothic", size = 12),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
  )

fig_rankAbund

ggsave(fig_rankAbund, filename = "figs/fig_rankAbundance.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)
dev.off()
```

## Examining changes in relative abundance as a function of species habitat affiliation

```{r}
## load in species trait dataset
trait_dat <- read.csv("data/species-trait-dat.csv")

# note: the classification of habitat type was taken from a working file of trait data for State of India's Birds report v2 (to be released in 2023). We used the following trait classifications:
# Wooded habitat: If it preferred some level of wooded habitat but not particularly specialized on rainforest/forest habitat. An example in this case is the black and orange flycatcher. While it is commonly found in shola forest habitat, this species is also common in degraded wooded areas, including timber plantations. If a species preferred just scrub habitat alone, we lumped it under this category.
# Forest: If a species was a forest specialist. 
# Grassland: While State of India's birds uses a separate classification for grassland & grassland+scrub, here we combine the two and use a single classification for Grassland. Eg. Black drongo - which favors both grassland areas and scrub habitat. There are four species that are classified as using 'open habitat' which had been subsumed under grasslands in our study - this includes - blue-tailed bee-eater, black-winged kite, long-tailed shrike (eBird lists it as preferring open habitats) and western yellow wagtail. 
# Generalist: If a species is truly a generalist species and is not particularly occupying/specialized on any particular wooded/forested/grassland habitat.

## join rel abun and species trait
## pivot longer
rel_abun_trait <- relAbun %>%
  pivot_longer(-scientific_name, names_to = "Time Period", values_to = "Relative abundance") %>% left_join(., trait_dat, by=c("scientific_name"="scientific_name")) %>%
   filter(Habitat.type != "Aquatic") %>%
  filter(`Relative abundance` !=0) %>%
  ungroup()
  
# visualization by habitat affiliation
rel_abun_trait$Habitat.type <- factor(rel_abun_trait$Habitat.type, levels=c("Forest", "Grassland", "Generalist", "Wooded Habitat"))

# log transformation of relative abundance to avoid negative values
rel_abun_trait$log_relative_abundance <- log10(rel_abun_trait$`Relative abundance` + 1 - min(rel_abun_trait$`Relative abundance`))

fig_relAbun_habitat <- grouped_ggbetweenstats(
  data = rel_abun_trait,
  x = `Time Period`,
  y = log_relative_abundance,
  grouping.var = `Habitat.type`,
  xlab = "Habitat.type", 
  ylab = "Relative Abundance",
  p.adjust.method = "fdr",
  #title = "Relative abundance by habitat type",
  plot.type = "box",
  ggplot.component = list(ggplot2::scale_y_continuous(
    breaks = seq(0, 0.04, 0.005),
    limits = (c(0, 0.04))))) +
  scale_fill_scico_d(palette = "roma") 

ggsave(fig_relAbun_habitat, filename = "figs/fig_relAbun_habitat_landscapeLevel.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)
dev.off()

## examining relative species abundance and body mass
## faceting by time period
fig_relAbun_mass <- ggplot(rel_abun_trait, aes(x= Mass, y=`Relative abundance`)) +  geom_point(shape = 21, colour = "black", fill = "white", size = 2, stroke = 1)+
   geom_smooth(method="lm", se=TRUE, fullrange=FALSE, level=0.95,linetype="solid") +  
  theme_bw() +
    scale_y_log10() +
   stat_regline_equation(label.y = 0.100, aes(label = ..eq.label..)) +
  stat_regline_equation(label.y = 0.500, aes(label = ..rr.label..)) +
  scale_x_log10() +
  facet_wrap(~`Time Period`) +
  labs(x="\nlog (Body mass)", 
       y="Relative abundance\n") +
  theme(axis.text = element_text(family = "Century Gothic", size = 13),
        legend.title = element_text(family = "Century Gothic"),
    legend.text = element_text(family = "Century Gothic"),
    text = element_text(family = "Century Gothic", size = 25))

ggsave(fig_relAbun_mass, filename = "figs/fig_relAbun_bodyMass.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)
dev.off()

## hand-wing index
fig_relAbun_hwi <- ggplot(rel_abun_trait, aes(x= Hand.Wing.Index, y=`Relative abundance`)) +  
  geom_point(shape = 21, colour = "black", fill = "white", size = 2, stroke = 1)+
   geom_smooth(method="lm", se=TRUE, fullrange=FALSE, level=0.95,linetype="solid") +  theme_bw() +
    scale_y_log10() +
  stat_regline_equation(label.y = 0.100, aes(label = ..eq.label..)) +
  stat_regline_equation(label.y = 0.500, aes(label = ..rr.label..)) +
  facet_wrap(~`Time Period`) +
  labs(x="\nHand-Wing Index", 
       y="Relative abundance\n") +
  theme(axis.text = element_text(family = "Century Gothic", size = 13),
        legend.title = element_text(family = "Century Gothic"),
    legend.text = element_text(family = "Century Gothic"),
    text = element_text(family = "Century Gothic", size = 25))

ggsave(fig_relAbun_hwi, filename = "figs/fig_relAbun_handWingIndex.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)
dev.off()
```

## Repeating the above analysis at the site-level
```{r}
# we remove modern site_code and get only distinct rows
hist_site_level <- hist_occ[,c(1:3)] %>%
  distinct(.)

relSpAbund_hist <- c()

for(i in 1:length(unique(hist_site_level$historical_site_code))) {
  
  a <- hist_site_level %>%
  filter(historical_site_code == unique(hist_site_level$historical_site_code)[i])

  b <- tibble::deframe(a[,c(1,3)]) ## choosing 1850-1900 data
  
  loc <- unique(hist_site_level$historical_site_code)[i] # what's the site_code?
  
  relSpAbund_hist[[i]] <- dirch_stats(b) %>%
  dplyr::select(species, bayes_mean)

  old_varname <-  c('species','bayes_mean')
  new_varname <- c('scientific_name', paste(loc,"_","1850", sep = ""))

  relSpAbund_hist[[i]] <- relSpAbund_hist[[i]] %>%
      data.table::setnames(old = old_varname, new = new_varname)

  names(relSpAbund_hist)[i] <- loc 
}

# save object but full_join across lists
relSpAbund_hist <- relSpAbund_hist %>%
    reduce(.f=full_join)

##  time period 2021
mod_site_level <- mod_occ[,c(1,3,5)] %>%
  group_by(scientific_name, historical_site_code) %>%
  mutate("2021" = sum(`2021`)) %>%
  distinct(.)

relSpAbund_2021 <- c()

for(i in 1:length(unique(mod_site_level$historical_site_code))) {
  
  a <- mod_site_level %>%
  filter(historical_site_code == unique(mod_site_level$historical_site_code)[i])

  b <- tibble::deframe(a[,c(1,2)]) ## choosing modern data
  
  loc <- unique(mod_site_level$historical_site_code)[i] # what's the site_code?
  
  relSpAbund_2021[[i]] <- dirch_stats(b) %>%
  dplyr::select(species, bayes_mean)

  old_varname <-  c('species','bayes_mean')
  new_varname <- c('scientific_name', paste(loc,"_","2021", sep = ""))

  relSpAbund_2021[[i]] <- relSpAbund_2021[[i]] %>%
      data.table::setnames(old = old_varname, new = new_varname)

  names(relSpAbund_2021)[i] <- loc 
}

# save object but full_join across lists
relSpAbund_2021 <- relSpAbund_2021 %>%
    reduce(.f=full_join)

## join all the datasets together
relSpAbund_by_site <- full_join(relSpAbund_hist, relSpAbund_2021, by = "scientific_name") %>%
  arrange(scientific_name) %>%
  replace(is.na(.), 0) 
```


## Visualizing differences in relative abundance over time at the site level
```{r}
## preparing dataframe for visualization
relSpAbund <- relSpAbund_by_site %>%
  pivot_longer(!scientific_name, names_to = "site_year", values_to = "relAbundance") %>%
  separate(site_year, into = c("site", "year"), sep = "_") %>%
  filter(relAbundance != 0)

## write results to file
write.csv(relSpAbund, "results/species-relative-abundance-siteLevel.csv", row.names = F)

## Please note: for the sake of downstream analysis, we have renamed 1850-1900 as 1850. In other words, each year - except for 2021 represents a 50 year time period. 

fig_relAbun_siteLevel <- relSpAbund %>%
  dplyr::select(-scientific_name) %>%
  ggplot(aes(x=year, y = relAbundance,
             fill = year)) +
  geom_boxplot() +
  scale_y_log10() +
  facet_wrap(~site)+
  xlab("Time period") +
  ylab("Relative abundance") +
  scale_fill_scico_d(palette = "batlow") +
  theme_bw() +
  theme(axis.title = element_text(family = "Century Gothic",
      size = 14, face = "bold"),
        axis.text = element_text(family="Century Gothic",size = 14),
      legend.title = element_text(family="Century Gothic",
                                    size = 14, face = "bold"),
        legend.key.size = unit(1,"cm"),
        legend.text = element_text(family="Century Gothic",size = 14)) +
  guides(fill="none")

ggsave(fig_relAbun_siteLevel, filename = "figs/fig_relAbun_siteLevel.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)
dev.off()
```

## Running generalized linear mixed models
```{r}
## overall
relSpAbund <- relSpAbund %>%
  mutate(relAbundance = case_when(relAbundance == 1 ~ 0.999,
                                  TRUE ~ relAbundance))

glmm_overall <- glmmTMB(relAbundance ~ year + (1|site) +(1|scientific_name),
                      data = relSpAbund, 
                      ziformula = ~1,
                      family = beta_family(link = "logit"))

summary(glmm_overall)

# visualize the random effects
ranef(glmm_overall)
str(ref <- ranef(glmm_overall))

## as.data.frame() provides RE's and conditional standard deviations:
str(dd <- as.data.frame(ref))

fig_ranef_relAbund <- ggplot(dd, aes(y=grp,x=condval)) +
        geom_point() + facet_wrap(~term,scales="free_x") +
        geom_errorbarh(aes(xmin=condval -2*condsd,
                           xmax=condval +2*condsd), height=0) +
  theme_bw() +
  theme(axis.title = element_text(family = "Century Gothic",
      size = 14, face = "bold"),
        axis.text = element_text(family="Century Gothic",size = 14),
      legend.title = element_text(family="Century Gothic",
                                    size = 14, face = "bold"),
        legend.key.size = unit(1,"cm"),
        legend.text = element_text(family="Century Gothic",size = 14)) +
  guides(fill="none")

ggsave(fig_ranef_relAbund, filename = "figs/fig_randomfEffects_relAbund.png", width = 15, height = 15, device = png(), units = "in", dpi = 300)
dev.off()
```
 Family: beta  ( logit )
Formula:          relAbundance ~ year + (1 | site) + (1 | scientific_name)
Zero inflation:                ~1
Data: relSpAbund

     AIC      BIC   logLik deviance df.resid 
 -2078.5  -2052.2   1045.3  -2090.5      584 

Random effects:

Conditional model:
 Groups          Name        Variance Std.Dev.
 site            (Intercept) 0.1303   0.3610  
 scientific_name (Intercept) 0.1234   0.3513  
Number of obs: 590, groups:  site, 28; scientific_name, 35

Dispersion parameter for beta family (): 27.8 

Conditional model:
            Estimate Std. Error z value Pr(>|z|)    
(Intercept)  -2.1801     0.1367 -15.946  < 2e-16 ***
year2021     -0.5777     0.1164  -4.964  6.9e-07 ***

Zero-inflation model:
            Estimate Std. Error z value Pr(>|z|)
(Intercept)   -22.49    3154.47  -0.007    0.994

report::report(glmm_overall)

We fitted a zero-inflated logistic mixed model (estimated using ML and
nlminb optimizer) to predict relAbundance with year (formula: relAbundance
~ year). The model included site as random effects (formula: list(~1 |
site, ~1 | scientific_name)). The model's total explanatory power is
substantial (conditional R2 = 0.45) and the part related to the fixed
effects alone (marginal R2) is of 0.08. The model's intercept,
corresponding to year = 1850, is at -2.18 (95% CI [-2.45, -1.91], p <
.001). Within this model:

  - The effect of year [2021] is statistically significant and negative (beta
= -0.58, 95% CI [-0.81, -0.35], p < .001; Std. beta = -0.58, 95% CI [-0.81,
-0.35])

Standardized parameters were obtained by fitting the model on a
standardized version of the dataset. 95% Confidence Intervals (CIs) and
p-values were computed using a Wald z-distribution approximation.
```{r}
## join relative abundance at site level with trait data
relAbun_Hab <- left_join(relSpAbund, trait_dat, by="scientific_name") %>%   filter(Habitat.type != "Aquatic") %>%
  ungroup()

## habitat affiliation
relAbun_Hab<- relAbun_Hab %>%
  mutate(relAbundance = case_when(relAbundance == 1 ~ 0.999,
                                  TRUE ~ relAbundance))

forest_glmm <- relAbun_Hab %>%
  filter(Habitat.type == "Forest")

glmm_forest <- glmmTMB(relAbundance ~ year + (1|site) +(1|scientific_name),
                      data = forest_glmm, 
                      ziformula = ~1,
                      family = beta_family(link = "logit"))
  
summary(glmm_forest)
```
Family: beta  ( logit )
Formula:          relAbundance ~ year + (1 | site) + (1 | scientific_name)
Zero inflation:                ~1
Data: forest_glmm

     AIC      BIC   logLik deviance df.resid 
 -1025.5  -1005.7    518.8  -1037.5      196 

Random effects:

Conditional model:
 Groups          Name        Variance Std.Dev.
 site            (Intercept) 0.15537  0.3942  
 scientific_name (Intercept) 0.03524  0.1877  
Number of obs: 202, groups:  site, 27; scientific_name, 20

Dispersion parameter for beta family (): 90.9 

Conditional model:
            Estimate Std. Error z value Pr(>|z|)    
(Intercept)  -2.8924     0.1356 -21.335  < 2e-16 ***
year2021     -0.7214     0.1281  -5.631 1.79e-08 ***

Zero-inflation model:
            Estimate Std. Error z value Pr(>|z|)
(Intercept)   -22.06    4333.38  -0.005    0.996

We fitted a zero-inflated logistic mixed model (estimated using ML and
nlminb optimizer) to predict relAbundance with year (formula: relAbundance ~
year). The model included site as random effects (formula: list(~1 | site,
~1 | scientific_name)). The model's total explanatory power is substantial
(conditional R2 = 0.54) and the part related to the fixed effects alone
(marginal R2) is of 0.20. The model's intercept, corresponding to year =
1850, is at -2.89 (95% CI [-3.16, -2.63], p < .001). Within this model:

  - The effect of year [2021] is statistically significant and negative (beta
= -0.72, 95% CI [-0.97, -0.47], p < .001; Std. beta = -0.72, 95% CI [-0.97,
-0.47])

Standardized parameters were obtained by fitting the model on a standardized
version of the dataset. 95% Confidence Intervals (CIs) and p-values were
computed using a Wald z-distribution approximation.

```{r}
grassland_glmm <- relAbun_Hab %>%
  filter(Habitat.type == "Grassland")

glmm_grassland <- glmmTMB(relAbundance ~ year +(1|scientific_name) +(1|site),
                      data = grassland_glmm, 
                      ziformula = ~1,
                      family = beta_family(link = "logit"))

summary(glmm_grassland)
```
Family: beta  ( logit )
Formula:          relAbundance ~ year + (1 | scientific_name) + (1 | site)
Zero inflation:                ~1
Data: grassland_glmm

     AIC      BIC   logLik deviance df.resid 
  -169.3   -159.3     90.6   -181.3       33 

Random effects:

Conditional model:
 Groups          Name        Variance Std.Dev.
 scientific_name (Intercept) 0.02646  0.1627  
 site            (Intercept) 4.14080  2.0349  
Number of obs: 39, groups:  scientific_name, 7; site, 17

Dispersion parameter for beta family ():  143 

Conditional model:
            Estimate Std. Error z value Pr(>|z|)    
(Intercept)  -2.6997     0.6686  -4.038 5.39e-05 ***
year2021     -0.7973     0.6128  -1.301    0.193    

Zero-inflation model:
            Estimate Std. Error z value Pr(>|z|)
(Intercept)   -22.24   10790.73  -0.002    0.998

We fitted a zero-inflated logistic mixed model (estimated using ML and
nlminb optimizer) to predict relAbundance with year (formula: relAbundance ~
year). The model included scientific_name as random effects (formula:
list(~1 | scientific_name, ~1 | site)). The model's total explanatory power
is substantial (conditional R2 = 0.96) and the part related to the fixed
effects alone (marginal R2) is of 0.04. The model's intercept, corresponding
to year = 1850, is at -2.70 (95% CI [-4.01, -1.39], p < .001). Within this
model:

  - The effect of year [2021] is statistically non-significant and negative
(beta = -0.80, 95% CI [-2.00, 0.40], p = 0.193; Std. beta = -0.80, 95% CI
[-2.00, 0.40])

Standardized parameters were obtained by fitting the model on a standardized
version of the dataset. 95% Confidence Intervals (CIs) and p-values were
computed using a Wald z-distribution approximation.

```{r}
wooded_glmm <- relAbun_Hab %>%
  filter(Habitat.type == "Wooded Habitat")

glmm_wooded <- glmmTMB(relAbundance ~ year + (1|site) +(1|scientific_name),
                      data = wooded_glmm, 
                      ziformula = ~1,
                      family = beta_family(link = "logit"))

summary(glmm_wooded)
```
Family: beta  ( logit )
Formula:          relAbundance ~ year + (1 | site) + (1 | scientific_name)
Zero inflation:                ~1
Data: wooded_glmm

     AIC      BIC   logLik deviance df.resid 
 -1390.7  -1367.4    701.4  -1402.7      352 

Random effects:

Conditional model:
 Groups          Name        Variance Std.Dev.
 site            (Intercept) 0.1646   0.4057  
 scientific_name (Intercept) 0.1060   0.3255  
Number of obs: 358, groups:  site, 28; scientific_name, 25

Dispersion parameter for beta family (): 25.4 

Conditional model:
            Estimate Std. Error z value Pr(>|z|)    
(Intercept)  -2.3874     0.1609 -14.835  < 2e-16 ***
year2021     -0.8220     0.1658  -4.959  7.1e-07 ***

Zero-inflation model:
            Estimate Std. Error z value Pr(>|z|)
(Intercept)   -22.26    3609.69  -0.006    0.995

We fitted a zero-inflated logistic mixed model (estimated using ML and
nlminb optimizer) to predict relAbundance with year (formula: relAbundance ~
year). The model included site as random effects (formula: list(~1 | site,
~1 | scientific_name)). The model's total explanatory power is substantial
(conditional R2 = 0.44) and the part related to the fixed effects alone
(marginal R2) is of 0.13. The model's intercept, corresponding to year =
1850, is at -2.39 (95% CI [-2.70, -2.07], p < .001). Within this model:

  - The effect of year [2021] is statistically significant and negative (beta
= -0.82, 95% CI [-1.15, -0.50], p < .001; Std. beta = -0.82, 95% CI [-1.15,
-0.50])

Standardized parameters were obtained by fitting the model on a standardized
version of the dataset. 95% Confidence Intervals (CIs) and p-values were
computed using a Wald z-distribution approximation.

```{r}
generalist_glmm <- relAbun_Hab %>%
  filter(Habitat.type == "Generalist")

glmm_generalist <- glmmTMB(relAbundance ~ year + (1|site) +(1|scientific_name),
                      data = generalist_glmm, 
                      ziformula = ~1,
                      family = beta_family(link = "logit"))

summary(glmm_generalist)
```

Family: beta  ( logit )
Formula:          relAbundance ~ year + (1 | site) + (1 | scientific_name)
Zero inflation:                ~1
Data: generalist_glmm

     AIC      BIC   logLik deviance df.resid 
 -1372.8  -1350.9    692.4  -1384.8      281 

Random effects:

Conditional model:
 Groups          Name        Variance Std.Dev.
 site            (Intercept) 0.009688 0.09843 
 scientific_name (Intercept) 0.229240 0.47879 
Number of obs: 287, groups:  site, 28; scientific_name, 16

Dispersion parameter for beta family (): 82.7 

Conditional model:
            Estimate Std. Error z value Pr(>|z|)    
(Intercept)  -3.8411     0.1695 -22.667  < 2e-16 ***
year2021      0.6339     0.1168   5.429 5.67e-08 ***

Zero-inflation model:
            Estimate Std. Error z value Pr(>|z|)
(Intercept)      -22       3534  -0.006    0.995

We fitted a zero-inflated logistic mixed model (estimated using ML and
nlminb optimizer) to predict relAbundance with year (formula: relAbundance ~
year). The model included site as random effects (formula: list(~1 | site,
~1 | scientific_name)). The model's total explanatory power is substantial
(conditional R2 = 0.53) and the part related to the fixed effects alone
(marginal R2) is of 0.09. The model's intercept, corresponding to year =
1850, is at -3.84 (95% CI [-4.17, -3.51], p < .001). Within this model:

  - The effect of year [2021] is statistically significant and positive (beta
= 0.63, 95% CI [0.41, 0.86], p < .001; Std. beta = 0.63, 95% CI [0.41,
0.86])

Standardized parameters were obtained by fitting the model on a standardized
version of the dataset. 95% Confidence Intervals (CIs) and p-values were
computed using a Wald z-distribution approximation.