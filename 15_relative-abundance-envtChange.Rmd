---
editor_options: 
  chunk_output_type: console
---

# Species relative abundance as a function of environmental changes

In this script, we will model changes in relative abundance as a function of environmental changes across the historical resurvey locations (environmental changes are calculated as differences in values of a predictor between modern vs. historical time period)

## Load necessary libraries
```{r}
# load libs
library(sf)
library(readr)
library(dplyr)
library(terra)
library(tidyr)
library(mapview)
library(sjPlot)
library(glmmTMB)
library(ggplot2)
library(effects)
library(lme4)
library(DHARMa)
library(ggpubr)
library(bbmle)
library(mgcv)

# function to z-transform data
scale_z <- function(x){
  (x - mean(x, na.rm=TRUE))/sd(x, na.rm=TRUE)
}
```

## Load processed land cover rasters
```{r}
lc_1848 <- terra::rast("results/processed-rasters/1848.tif")
lc_2018 <- terra::rast("results/processed-rasters/2018reclassified.tif")
```

## Load modern resurvey locations
```{r}
# load sites
sites <- read_csv("data/list-of-resurvey-locations.csv")
sites <- distinct(sites, modern_site_code, historical_site_code, longitude, latitude)
sites <- sites[-c(1:50),]
```

## Create spatial data within a 250m buffer for each site
```{r}
# make spatial data from sites, with a 250m buffer
sites_sf = st_as_sf(
  sites, coords = c("longitude", "latitude"),
  crs = 4326
) |> 
  st_transform(32643) |> 
  st_buffer(250)
```

## Extract land cover data across locations from the 1848 and the 2018 rasters
```{r}
# first, we will polygonize the rasters 
vect1848 <- as.polygons(lc_1848)
vect2018 <- as.polygons(lc_2018)

# get intersection of the historical resurvey sites with 1848 and 2018 vector data
lc_sites <- lapply(
  list(vect1848, vect2018), function(x) {
    st_intersection(st_as_sf(x), sites_sf)
  }
)

# calculate total area for each lc type for sites based on historical site code for each time period
lc_sites <- lapply(lc_sites, function(df) {
  df |> 
    mutate(
      area = as.numeric(st_area(df))
    ) |> 
    st_drop_geometry() |> 
    group_by(modern_site_code, name) |> 
    summarise(total_area = sum(area))
})

# add year and merge
lc_sites <- Map(
  lc_sites, c(1848, 2018),
  f = function(df, y) {
    df$year = y
    df
  }
) |> 
  bind_rows()
```

## Calculate change in land cover between time periods

For this calculation, we use a simple formulation which essentially replicates the calculation of NDVI = (value in time period Y - value in time period X)/(value in time period Y + value in time period X). This gives us a value ranging between -1 to 1, with higher negative values implying loss in time period Y and positive values imply gain in time period Y
```{r}
# get lc change sites
lc_change_dat <- lc_sites |> 
  pivot_wider(
    id_cols = c("modern_site_code", "name"),
    names_from = c("year"),
    values_from = "total_area",
    values_fn = mean
  ) |> 
  rename(
    year_1848 = `1848`,
    year_2018 = `2018`
  ) %>%
  left_join(., sites_sf, by="modern_site_code") %>%
  replace(is.na(.), 0) %>%
  mutate("lc_change" = (year_2018 - year_1848)/(year_2018 + year_1848)) #  -negative values implies loss and + positive values implies gain

# save as is for further processing
write_csv(
  lc_change_dat, file = "results/lc_change.csv"
)
```

## Calculate change in climate values at sampling sites
```{r}
# load climate data
raster_temp = list.files("data/climate/", pattern = "t_mean", full.names = T) |> 
  lapply(rast)

raster_rain = list.files("data/climate/", pattern = "ppt", full.names = T) |> 
  lapply(rast)

# get difference between first and last files
climate_change = lapply(
  list(raster_temp, raster_rain),
  function(le) {
    lapply(le, function(le2) {
      le2[[length(names(le2))]] - le2[[1]]
    })
  }
) |> 
  Reduce(f = c) # convert to single list

# get raster names
climate_change_names = lapply(climate_change, function(ra) {
  lapply(ra, function(r) {
    r |> names() |> stringr::str_extract("(.*?)(?=_\\d+)")
  })
}) |> unlist()

# get mean change within 250m buffer of resurvey locs
climate_change_sites = lapply(
  climate_change, function(ra) {
    terra::extract(
      ra, 
      y = terra::vect(
        sites_sf |> 
          st_transform(4326)
      ), fun = mean
    )  
  }
)

# combine all metrics
climate_change_sites = Reduce(f = left_join, x = climate_change_sites)

# attach to sampling sites
sites <- mutate(sites, ID = seq(nrow(sites)))
clim_change_dat <- left_join(sites, climate_change_sites)

# save site data
write_csv(
  clim_change_dat, file = "results/climate_change.csv"
)
```

## Load species relative abundance
```{r}
relAbun <- read.csv("results/species-relative-abundance-siteLevel.csv")
```

## Load species trait data
```{r}
trait_dat <- read.csv("data/species-trait-dat.csv")
```

## Is there a significant association between change in relative abundance and change in an environmental covariate across time periods?

We will first prepare the dataframes necessary for running linear mixed models.
```{r}
## preparing the relative abundance dataframe for a mixed effects model
names(relAbun) <- c("scientific_name","historical_site_code","year","relAbundance")

pivot_1850 <- relAbun %>%
  filter(year != 2021) %>%
  pivot_wider(., names_from = "year", values_from = "relAbundance")

pivot_2021 <- relAbun %>%
  filter(year != 1850) %>%
  pivot_wider(., names_from = "year", values_from = "relAbundance")

# calculate difference between modern and historical time periods
# positive value implies gain in relative abundance in 2021 compared to 1850, while negative value implies loss in relative abundance in 2021 compared to 1850
relAbun_wide <- full_join(pivot_1850, pivot_2021, by=c("scientific_name","historical_site_code")) %>%
  mutate("relAbunChange" = `2021` - `1850`) %>%
  mutate("abunIndex" = log10(`2021`/`1850`))

## prepare the land cover data
## calculating mean change at the level of the historical site code
## prior to this calculation, we observed a gain in forest cover across most of the resurvey locations except for OTCM1 (loss = -0.79)
lc_meanChange <- lc_change_dat %>%
  group_by(historical_site_code, name) %>%
  summarise(lc_change = mean(lc_change)) 

# scale values of land cover change
# lc_scaledChange <- lc_meanChange %>%
#  group_by(name) %>%
#  mutate(lc_scaled = scale_z(lc_change))

## make land cover data wider
lc_glmm <- lc_meanChange %>%
  pivot_wider(id_cols = historical_site_code, 
              names_from = name, 
              values_from = lc_change)

## prepare climate change data
clim_change_glmm <- clim_change_dat %>%
  dplyr::select(historical_site_code, t_mean_dry_2010, t_mean_rainy_2010, ppt_dry_2010, ppt_rainy_2010) %>%
  group_by(historical_site_code) %>%
  summarise(across(everything(), mean))

## join all three dataframes together
## note that due to gaps in the historical land cover map, we have to forego two unique historical survey locations (TSTE and WTCM)

## dataframe for glmm
glmm_data <- left_join(lc_glmm, relAbun_wide,
                       by = "historical_site_code") %>%
  left_join(., clim_change_glmm, by = "historical_site_code") %>% as.data.frame()

## scale the climate data
glmm_data <- glmm_data %>%
  mutate(t_mean_dry_2010_z = scale_z(t_mean_dry_2010)) %>%
  mutate(t_mean_rainy_2010_z = scale_z(t_mean_rainy_2010)) %>%
  mutate(ppt_dry_2010_z = scale_z(ppt_dry_2010)) %>%
  mutate(ppt_rainy_2010_z = scale_z(ppt_rainy_2010)) 
```

## Test for correlations between covariates
```{r}
library(psych)
for_corr <- glmm_data[,c(2:7,16:19)] %>%
  distinct()

pairs.panels(for_corr)

# correlative analyses suggests that t_mean_dry2010 is highly correlated with t_mean_rainy2010 and ppt_mean_rainy2010
# for future analyses, we will only include t_mean_dry2010 and ppt_mean_dry2010
```

## Running models with all data
```{r}
overall_lc<- glmmTMB(relAbunChange ~ shola_forest + shola_grassland +
                 settlements + agriculture + plantations + water_bodies+
                   t_mean_dry_2010_z + ppt_dry_2010_z +
                 (1|scientific_name),
               data = glmm_data,
               family = gaussian())

summary(overall_lc)

overall_clim <- glmmTMB(relAbunChange ~ t_mean_dry_2010_z + 
                        ppt_dry_2010_z + (1|scientific_name),
                        data =glmm_data,
                        family = gaussian())
summary(overall_clim)
```


## Run the mixed-effects models, but incorporate species habitat affiliation
```{r}
glmm_habitat <- left_join(glmm_data, trait_dat, by = "scientific_name") 

## run the glmm
## grassland birds
glmm_grassland <-  glmm_habitat %>%
  filter(Habitat.type == "Grassland")

grass_mod <- glm(abunIndex ~ shola_forest + shola_grassland +
                 settlements + agriculture + plantations,
               data = glmm_grassland)


g2 <- update(grass_mod, .~. -plantations)
g3 <- update(g2, .~. -shola_grassland)
g4 <- update(g3, .~. -settlements)
g5 <- update(g4, .~. -shola_forest)

summary(grass_mod)
summary(g2)
summary(g3)
summary(g4)
summary(g5)

plot_model(g4)

stepAIC(grass_mod, g2, g3, g4, g5)

grass_null <- lmer(relAbunChange ~.,
                    data = glmm_grassland)


fig_relAbun_grass <- ggplot(data=glmm_grassland,aes(x=settlements,y=relAbunChange)) +
   #scale_y_log10() +
  #geom_abline(slope=1, intercept=0,linetype="dashed") +
  #scale_x_log10() +
  labs(y = "Change in relative abundance", 
       x = "% change in grassland habitat") +
   geom_point(shape = 21, colour = "black", fill = "white", size = 2, stroke = 1)+
   geom_smooth(method="lm", se=TRUE, fullrange=FALSE, level=0.95,linetype="solid")+
  stat_regline_equation(aes(label = ..rr.label..)) +
  theme_bw() +
  theme(axis.text = element_text(family = "Century Gothic", size = 13),
        legend.title = element_text(family = "Century Gothic"),
    legend.text = element_text(family = "Century Gothic"),
    text = element_text(family = "Century Gothic", size = 25))

fig_relAbun_grass

ggsave(fig_1850v2021_rel, filename = "figs/fig_1850-1900vs2021_relAbun.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)
dev.off()





grass_clim <- glmmTMB(relAbunChange ~ t_mean_dry_2010_z + 
                        ppt_dry_2010_z + (1|scientific_name),
                      data = glmm_grassland,
                      family = gaussian())

summary(grass_clim)

## forest birds
glmm_forest <-  glmm_habitat %>%
  filter(Habitat.type == "Forest")

forest_lc <- glmmTMB(relAbunChange ~ shola_forest + 
                            shola_grassland + settlements 
                          + agriculture + plantations+
                 (1|scientific_name),
               data = glmm_forest,
               family = gaussian())


forest_clim <- glmmTMB(relAbunChange ~ t_mean_dry_2010_z + 
                        ppt_dry_2010_z + (1|scientific_name),
                      data = glmm_forest,
                      family = gaussian())

summary(forest_lc)
summary(forest_clim)

## generalist birds
glmm_generalist <-  glmm_habitat %>%
  filter(Habitat.type == "Generalist")

generalist_lc <- glmmTMB(relAbunChange ~ shola_forest + 
                            shola_grassland + settlements 
                          + agriculture + plantations+
                 (1|scientific_name),
               data = glmm_generalist,
               family = gaussian())


generalist_clim <- glmmTMB(relAbunChange ~ t_mean_dry_2010_z + 
                        ppt_dry_2010_z + (1|scientific_name),
                      data = glmm_generalist,
                      family = gaussian())

summary(generalist_lc)
summary(generalist_clim)

```








## Run mixed-effects models examining species relative abundance and land cover change
```{r}


## run the glmm
glmm_lc_relAbun <- glmer(relAbunChange ~ `Shola Grassland` + `Shola Forest` + `Settlements`+ `Plantations (Tea & Timber)` + `Agricultural Land` + (1|scientific_name) + (1|historical_site_code), 
                        data = glmm_relAbun, family = gaussian(link="identity"))

summary(glmm_lc_relAbun)
plot_model(glmm_lc_relAbun, type="pred")
report::report(glmm_lc_relAbun)

# We fitted a linear mixed model (estimated using REML and nloptwrap optimizer) to predict relAbunChange with Shola Grassland, Shola Forest, Settlements, Plantations (Tea & Timber) and Agricultural Land (formula: relAbunChange ~ `Shola Grassland` + `Shola Forest` + Settlements + `Plantations (Tea & Timber)` + `Agricultural Land`). The model included scientific_name and historical_site_code as random effects (formula: list(~1 | scientific_name, ~1 | historical_site_code)). The model's total explanatory power is moderate (conditional R2 = 0.13) and the part related to the fixed effects alone (marginal R2) is of 2.07e-03. The model's intercept, corresponding to Shola Grassland = 0, Shola Forest = 0, Settlements = 0, Plantations (Tea & Timber) = 0 and Agricultural Land = 0, is at -8.92e-03 (95% CI [-0.02, 1.72e-03], t(4905) = -1.64, p = 0.100). Within this model:

#  - The effect of Shola Grassland is statistically non-significant and negative (beta = -3.37e-03, 95% CI [-0.01, 6.85e-03], t(4905) = -0.65, p = 0.518; Std. beta = -0.01, 95% CI [-0.04, 0.02])
 # - The effect of Shola Forest is statistically non-significant and negative (beta = -7.56e-04, 95% CI [-2.44e-03, 9.28e-04], t(4905) = -0.88, p = 0.379; Std. beta = -0.02, 95% CI [-0.05, 0.02])
#  - The effect of Settlements is statistically non-significant and positive (beta = 9.92e-04, 95% CI [-7.97e-04, 2.78e-03], t(4905) = 1.09, p = 0.277; Std. beta = 0.02, 95% CI [-0.01, 0.05])
#  - The effect of Plantations (Tea & Timber) is statistically non-significant and positive (beta = 2.32e-03, 95% CI [-4.72e-04, 5.11e-03], t(4905) = 1.63, p = 0.103; Std. beta = 0.03, 95% CI [-5.35e-03, 0.06])
#  - The effect of Agricultural Land is statistically non-significant and positive (beta = 1.20e-03, 95% CI [-1.35e-03, 3.74e-03], t(4905) = 0.92, p = 0.357; Std. beta = 0.01, 95% CI [-0.02, 0.05])

# Standardized parameters were obtained by fitting the model on a standardized version of the dataset. 95% Confidence Intervals (CIs) and p-values were computed using the Wald approximation
```


## Run mixed-effects models examining persistence probabilties and climate change
```{r}


## run the glmm
glmm_cc <- glmer(relAbunChange ~ t_mean_dry_2010_z + t_mean_rainy_2010_z +                   ppt_dry_2010_z + ppt_rainy_2010_z +
                          (1|scientific_name) + (1|historical_site_code), 
                        data = glmm_cc_change, family = gaussian(link="identity"))

summary(glmm_cc)
plot_model(glmm_cc, type="pred")
plot_model(glmm_cc, type = "est")
report::report(glmm_cc)

# We fitted a linear mixed model (estimated using REML and nloptwrap optimizer) to predict persProbChange with t_mean_dry_2010_z, t_mean_rainy_2010_z, ppt_dry_2010_z and ppt_rainy_2010_z (formula: persProbChange ~ t_mean_dry_2010_z + t_mean_rainy_2010_z + ppt_dry_2010_z + ppt_rainy_2010_z). The model included scientific_name and historical_site_code as random effects (formula: list(~1 | scientific_name, ~1 | historical_site_code)). The model's total explanatory power is substantial (conditional R2 = 0.60) and the part related to the fixed effects alone (marginal R2) is of 9.72e-03. The model's intercept, corresponding to t_mean_dry_2010_z = 0, t_mean_rainy_2010_z = 0, ppt_dry_2010_z = 0 and ppt_rainy_2010_z = 0, is at 0.22 (95% CI [0.19, 0.24], t(1250) = 15.48, p < .001). Within this model:

#  - The effect of t mean dry 2010 z is statistically non-significant and positive (beta = 0.02, 95% CI [-0.15, 0.20], t(1250) = 0.26, p = 0.795; Std. beta = 0.14, 95% CI [-0.90, 1.18])
#  - The effect of t mean rainy 2010 z is statistically non-significant and negative (beta = -0.02, 95% CI [-0.08, 0.04], t(1250) = -0.72, p = 0.472; Std. beta = -0.13, 95% CI [-0.50, 0.23])
#  - The effect of ppt dry 2010 z is statistically non-significant and negative (beta = -0.02, 95% CI [-0.04, 0.01], t(1250) = -1.11, p = 0.268; Std. beta = -0.09, 95% CI [-0.26, 0.07])
#  - The effect of ppt rainy 2010 z is statistically non-significant and negative (beta = -8.50e-03, 95% CI [-0.14, 0.12], t(1250) = -0.13, p = 0.895; Std. beta = -0.05, 95% CI [-0.80, 0.70])

# Standardized parameters were obtained by fitting the model on a standardized version of the dataset. 95% Confidence Intervals (CIs) and p-values were computed using the Wald approximation. 
```

